
# 将你的植物迁移到云端

![本课的 sketchnote 概述](../../../../sketchnotes/lesson-8.jpg)

> [Nitya Narasimhan](https://github.com/nitya) 的草图笔记。单击图像可查看更大的版本。

本课程是 [Microsoft Reactor](https://developer.microsoft.com) 的 [IoT 初学者项目 2 - 数字农业系列](https://youtube.com/playlist?list=PLmsFUfdnGr3yCutmcVg6eAUEfsGiFXgcx) 的一部分/reactor/?WT.mc_id=academic-17441-jabenn)。

[![使用 Azure IoT 中心将您的设备连接到云](https://img.youtube.com/vi/bNxjopXkhvk/0.jpg)](https://youtu.be/bNxjopXkhvk)

## 课前测验

[课前测验](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/15)

＃＃ 介绍

在上一课中，您学习了如何将工厂连接到 MQTT 代理并通过本地运行的某些服务器代码控制中继。这构成了连接互联网的自动浇水系统的核心，从家庭的个体植物到商业农场都可以使用该系统。

IoT 设备与公共 MQTT 代理进行通信作为演示原理的一种方式，但这并不是最可靠或最安全的方式。在本课程中，您将了解云以及公共云服务提供的物联网功能。您还将了解如何将您的工厂从公共 MQTT 代理迁移到这些云服务之一。

在本课中，我们将介绍：

* [什么是云？](#what-is-the-cloud)
* [创建云订阅](#create-a-cloud-subscription)
* [云物联网服务](#cloud-iot-services)
* [在云端创建 IoT 服务](#create-an-iot-service-in-the-cloud)
* [与 IoT 中心通信](#communicate-with-iot-hub)
* [将您的设备连接到 IoT 服务](#connect-your-device-to-the-iot-service)

## 什么是云？

在云出现之前，当一家公司想要向其员工（例如数据库或文件存储）或公众（例如网站）提供服务时，他们会构建并运行数据中心。其范围从具有少量计算机的房间到具有许多计算机的建筑物。该公司将管理一切，包括：

* 购买电脑
* 硬件维护
* 电源和冷却
* 联网
* 安全性，包括保护建筑物和计算机上软件的安全
* 软件安装和更新

这可能非常昂贵，需要大量熟练的员工，并且在需要时改变非常缓慢。例如，如果一家在线商店需要为繁忙的假期做好计划，他们需要提前几个月计划购买更多硬件，配置它，安装它并安装软件来运行他们的销售流程。假期结束后，销量回落，他们花钱购买的电脑将闲置到下一个旺季。

✅ 您认为这会让公司迅速采取行动吗？如果一家在线服装零售商因为名人穿着衣服而突然走红，他们是否能够足够快地提高计算能力来支持突然涌入的订单？

### 别人的电脑

云经常被戏称为“别人的计算机”。最初的想法很简单——您不用购买计算机，而是租用别人的计算机。其他人（云计算提供商）将管理巨大的数据中心。他们将负责购买和安装硬件、管理电源和冷却、网络、建筑安全、硬件和软件更新等一切。作为客户，您可以租用所需的计算机，随着需求激增而租用更多计算机，然后在需求下降时减少租用数量。这些云数据中心遍布世界各地。

![Microsoft 云数据中心](../../../../images/azure-region-existing.png)
![微软云数据中心计划扩建](../../../../images/azure-region-planned-expansion.png)

这些数据中心的规模可能有数平方公里。上面的图片是几年前在 Microsoft 云数据中心拍摄的，显示了初始大小以及计划的扩展。扩建清理面积超过5平方公里。

> 💁 这些数据中心需要大量电力，以至于有些数据中心拥有自己的发电站。由于它们的规模和云提供商的投资水平，它们通常非常环保。它们比大量的小型数据中心更有效率，它们主要依靠可再生能源运行，云提供商努力减少浪费，减少用水量，并重新种植森林，以弥补为建设数据中心提供空间而砍伐的森林。您可以在 [Azure 可持续发展网站](https://azure.microsoft.com/global-infrastruct/sustainability/?WT.mc_id=academic-17441-jabenn) 上详细了解云提供商如何致力于可持续发展。

✅ 做一些研究：阅读主要云，例如 [Microsoft 的 Azure](https://azure.microsoft.com/?WT.mc_id=academic-17441-jabenn) 或 [Google 的 GCP](https:// /cloud.google.com）。他们有多少个数据中心？它们位于世界何处？

使用云可以降低公司的成本，并使他们能够专注于自己最擅长的事情，从而将云计算专业知识交到提供商手中。公司不再需要租用或购买数据中心空间、向不同的提供商支付连接和电力费用或聘请专家。相反，他们可以每月向云提供商支付一份账单，以解决一切问题。

然后，云提供商可以利用规模经济来降低成本，以较低的成本批量购买计算机，投资工具以减少维护工作量，甚至设计和构建自己的硬件来改进其云产品。

### 微软 Azure

Azure 是 Microsoft 的开发者云，您将在这些课程中使用它。下面的视频简要概述了 Azure：

[![Azure 视频概述](../../../../images/what-is-azure-video-thumbnail.png)](https://www.microsoft.com/videoplayer/embed/RE4Ibng? WT.mc_id=academic-17441-jabenn)

## 创建云订阅

要使用云中的服务，您需要向云提供商注册订阅。在本课程中，您将注册 Microsoft Azure 订阅。如果你已经有 Azure 订阅，则可以跳过此任务。此处描述的订阅详细信息在撰写本文时正确无误，但可能会发生变化。

> 💁 如果您通过学校访问这些课程，您可能已经有可用的 Azure 订阅。请咨询你的老师。

您可以注册两种不同类型的免费 Azure 订阅：

* **Azure for Students** - 这是专为 18 岁以上学生设计的订阅。您不需要信用卡即可注册，并且可以使用学校电子邮件地址来验证您是学生。注册后，您将获得 100 美元用于购买云资源，以及免费服务，包括免费版本的 IoT 服务。有效期为 12 个月，您可以在学生身份期间每年续签。

* **Azure 免费订阅** - 这是面向非学生的任何人的订阅。您需要一张信用卡来注册订阅，但您的卡不会被计费，这只是用来验证您是一个真正的人，而不是机器人。您将获得 200 美元的积分，可在前 30 天内使用任何服务，以及免费的 Azure 服务。一旦您的信用额度用完，除非您转换为现收现付订阅，否则不会从您的卡中扣款。

> 💁 Microsoft 确实为 18 岁以下的学生提供 Azure for Students Starter 订阅，但在撰写本文时，它不支持任何 IoT 服务。

### 任务 - 注册免费云订阅

如果你是 18 岁以上的学生，则可以注册 Azure 学生版订阅。您需要使用学校电子邮件地址进行验证。您可以通过以下两种方式之一执行此操作：

* 在 [education.github.com/pack](https://education.github.com/pack) 注册 GitHub 学生开发包。这使您可以访问一系列工具和产品，包括 GitHub 和 Microsoft Azure。注册开发人员包后，您就可以激活面向学生的 Azure 优惠。

* 直接在 [azure.microsoft.com/free/students](https://azure.microsoft.com/free/students/?WT.mc_id=academic-17441-jabenn) 注册 Azure for Students 帐户。

> ⚠️ 如果您的学校电子邮件地址无法识别，请在此存储库中提出问题](https://github.com/Microsoft/IoT-For-Beginners/issues)，我们将查看是否可以将其添加到Azure 学生允许列表。

如果你不是学生，或者没有有效的学校电子邮件地址，则可以注册 Azure 免费订阅。

* 在 [azure.microsoft.com/free](https://azure.microsoft.com/free/?WT.mc_id=academic-17441-jabenn) 注册 Azure 免费订阅

## 云物联网服务

您一直在使用的公共测试 MQTT 代理在学习时是一个很好的工具，但作为在商业环境中使用的工具有许多缺点：

* 可靠性 - 这是一项免费服务，没有任何保证，并且可以随时关闭
* 安全性 - 它是公开的，因此任何人都可以监听您的遥测或发送命令来控制您的硬件
* 性能 - 它仅针对少量测试消息而设计，因此无法应对发送的大量消息
* 发现 - 无法知道连接了哪些设备

云中的物联网服务解决了这些问题。它们由大型云提供商维护，他们在可靠性方面投入巨资，并随时解决可能出现的任何问题。它们具有内置的安全功能，可以阻止黑客读取您的数据或发送恶意命令。它们还具有高性能，每天能够处理数百万条消息，并利用云根据需要进行扩展。

> 💁 尽管您需要按月付费才能获得这些好处，但大多数云提供商都提供免费版本的物联网服务，每天的消息数量或可连接的设备数量有限。这个免费版本通常足以让开发人员了解该服务。在本课程中，您将使用免费版本。

IoT 设备使用设备 SDK（提供使用服务功能的代码的库）或直接通过 MQTT 或 HTTP 等通信协议连接到云服务。设备 SDK 通常是最简单的途径，因为它会为您处理所有事情，例如了解要发布或订阅哪些主题以及如何处理安全性。

![设备使用设备 SDK 连接到服务。服务器代码还通过 SDK 连接到服务](../../../../images/iot-service-connectivity.png)

然后，您的设备通过此服务与应用程序的其他部分进行通信 - 类似于通过 MQTT 发送遥测数据和接收命令的方式。这通常使用服务 SDK 或类似的库。消息从您的设备发送到服务，然后应用程序的其他组件可以读取它们，然后消息可以发送回您的设备。

![没有有效密钥的设备无法连接到 IoT 服务](../../../../images/iot-service-allowed-denied-connection.png)

这些服务通过了解可以连接和发送数据的所有设备来实现安全性，方法是让设备预先注册到服务，或者向设备提供可用于首次向服务注册的设备密钥或证书。他们连接。未知设备无法连接，如果它们尝试，服务会拒绝连接并忽略它们发送的消息。

✅ 做一些研究：拥有任何设备或代码都可以连接的开放物联网服务有什么缺点？您能找到黑客利用这一点的具体例子吗？

应用程序的其他组件可以连接到 IoT 服务并了解所有连接或注册的设备，并直接批量或单独地与它们通信。

> 💁 物联网服务还实现了额外的功能，并且云提供商拥有可以连接到该服务的额外服务和应用程序。例如，如果您想要将所有设备发送的所有遥测消息存储在数据库中，通常只需在云提供商的配置工具中单击几下即可将服务连接到数据库并将数据流式传输。

## 在云端创建 IoT 服务

现在您已拥有 Azure 订阅，您可以注册 IoT 服务。Microsoft 的 IoT 服务称为 Azure IoT Hub。

![Azure IoT 中心徽标](../../../../images/azure-iot-hub-logo.png)

下面的视频简要概述了 Azure IoT 中心：

[![Azure IoT 中心视频概述](https://img.youtube.com/vi/smuZaZZXKsU/0.jpg)](https://www.youtube.com/watch?v=smuZaZZXKsU)

> 🎥 点击上图观看视频

✅ 花点时间做一些研究并阅读 [Microsoft IoT 中心文档](https://docs.microsoft.com/azure/iot-hub/about-iot-hub?WT.mc_id=学术-17441-jabenn)。

Azure 中提供的云服务可以通过基于 Web 的门户或命令行界面 (CLI) 进行配置。对于此任务，您将使用 CLI。

### 任务 - 安装 Azure CLI

要使用 Azure CLI，首先必须将其安装在 PC 或 Mac 上。

1. 按照 [Azure CLI 文档](https://docs.microsoft.com/cli/azure/install-azure-cli?WT.mc_id=academic-17441-jabenn) 中的说明安装 CLI。

1. Azure CLI 支持许多扩展，这些扩展增加了管理各种 Azure 服务的功能。通过从命令行或终端运行以下命令来安装 IoT 扩展：

    ````嘘
    az 扩展添加 --name azure-iot
    ````

1. 在命令行或终端中，运行以下命令以从 Azure CLI 登录到 Azure 订阅。

    ````嘘
    登录
    ````

    将在您的默认浏览器中启动一个网页。使用用于注册 Azure 订阅的帐户登录。登录后，您可以关闭浏览器选项卡。

1. 如果您有多个 Azure 订阅（例如学校提供的订阅）和您自己的 Azure for Students 订阅，则您需要选择要使用的订阅。运行以下命令列出您有权访问的所有订阅：

    ````嘘
    az 帐户列表 --输出表
    ````

    在输出中，您将看到每个订阅的名称及其“SubscriptionId”。

    ````输出
    ➜~az账户列表--输出表
    名称 CloudName SubscriptionId 状态 IsDefault
    ---------------------- ----------- ----------------- ------------------- ------- -----------
    学校订阅 AzureCloud cb30cde9-814a-42f0-a111-754cb788e4e1 已启用 True
    适用于学生的 Azure AzureCloud fa51c31b-162c-4599-add6-781def2e1fbf 已启用 False
    ````

    要选择您要使用的订阅，请使用以下命令：

    ````嘘
    az 帐户集--订阅
    ````

    替换 `
    ` 替换为您要使用的订阅的 ID。运行此命令后，重新运行该命令以列出您的帐户。您将看到您刚刚设置的订阅的“IsDefault”列将被标记为“True”。

### 任务 - 创建资源组

Azure 服务（例如 IoT 中心实例、虚拟机、数据库或 AI 服务）被称为**资源**。每个资源都必须位于**资源组**内，即一个或多个资源的逻辑分组。

> 💁 使用资源组意味着您可以同时管理多个服务。例如，当您完成该项目的所有课程后，您可以删除该资源组，其中的所有资源将被自动删除。

1. 全球有多个Azure数据中心，分为多个区域。创建 Azure 资源或资源组时，必须指定创建位置。运行以下命令以获取位置列表：

    ````嘘
    az 帐户列表位置 --输出表
    ````

    您将看到位置列表。这个清单会很长。

    > 💁 在撰写本文时，您可以部署到 65 个位置。

    ````输出
        ➜ ~ az 帐户列表位置 --输出表
    显示名称 名称 区域显示名称
    ------------------------ ---------------------------------- ------- ------------------------------------------
    美国东部 eastus (美国) 美国东部
    美国东部 2 eastus2 (美国) 美国东部 2
    美国中南部 Southcentralus (US) 美国中南部
    ...
    ````

    记下离您最近的区域的“名称”列中的值。您可以在 [Azure 地理页面](https://azure.microsoft.com/global-infrastruct/geographies/?WT.mc_id=academic-17441-jabenn) 上的地图上找到这些区域。

1. 运行以下命令创建名为“soil-moisture-sensor”的资源组。资源组名称在您的订阅中必须是唯一的。

    ````嘘
    az group create --name 土壤湿度传感器 \
                    - 地点
     
    ````

    替换 `
      ` 替换为您在上一步中选择的位置。

### 任务 - 创建 IoT 中心

现在，您可以在资源组中创建 IoT 中心资源。

1. 使用以下命令创建 IoT 中心资源：

    ````嘘
    az iot hub create --resource-group 土壤湿度传感器 \
                      --sku F1 \
                      --分区计数 2 \
                      - 姓名
       
    ````

    替换 `
        
         `
                  
                 
                
               
              
             
            
           
          
         
        
       
      
     
    
   