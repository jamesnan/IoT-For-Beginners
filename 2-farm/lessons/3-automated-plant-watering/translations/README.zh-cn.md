
# 自动植物浇水

![本课的 sketchnote 概述](../../../../sketchnotes/lesson-7.jpg)

> [Nitya Narasimhan](https://github.com/nitya) 的草图笔记。单击图像可查看更大的版本。

本课程是 [Microsoft Reactor](https://developer.microsoft.com/reactor/?WT.mc_id=academic-17441-jabenn) 的 [IoT 初学者项目 2 - 数字农业系列](https://youtube.com/playlist?list=PLmsFUfdnGr3yCutmcVg6eAUEfsGiFXgcx) 的一部分。

[![物联网驱动的自动化植物浇水](https://img.youtube.com/vi/g9FfZwv9R58/0.jpg)](https://youtu.be/g9FfZwv9R58)

## 课前测验

[课前测验](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/13)

## 介绍

在上一课中，您学习了如何监测土壤湿度。在本课程中，您将学习如何构建响应土壤湿度的自动浇水系统的核心组件。您还将了解计时 - 传感器如何需要一段时间来响应变化，以及执行器如何需要时间来改变传感器测量的属性。

在本课中，我们将介绍：

* [从低功耗物联网设备控制高功率设备](#control-high-power-devices-from-a-low-power-iot-device)
* [控制继电器](#control-a-relay)
* [通过 MQTT 控制您的工厂](#control-a-relay)
* [传感器和执行器时序](#sensor-and-actuator-timing)
* [向您的工厂控制服务器添加计时](#add-timing-to-your-plant-control-server)

## 从低功耗物联网设备控制高功耗设备

物联网设备使用低电压。虽然这对于传感器和 LED 等低功耗执行器来说已经足够了，但对于控制较大的硬件（例如用于灌溉的水泵）来说，这太低了。即使是用于室内植物的小型泵也会为物联网开发套件消耗过多的电流，并且会烧坏电路板。

> 🎓 电流，以安培 (A) 为单位测量，是流过电路的电量。电压提供推力，电流则提供推力的大小。您可以在[维基百科上的电流页面](https://wikipedia.org/wiki/Electric_current) 上阅读有关电流的更多信息。

解决方案是将泵连接到外部电源，并使用执行器打开泵，类似于打开灯的方式。您的手指需要少量的电力（以您体内的能量形式）来打开开关，这会将灯连接到 110v/240v 的市电。

![灯开关打开灯的电源](../../../../images/light-switch.png)

> 🎓 [干线电力](https://wikipedia.org/wiki/Mains_electricity) 是指通过世界许多地区的国家基础设施输送给家庭和企业的电力。

✅ IoT 设备通常可以提供 3.3V 或 5V 电压，电流小于 1 安培 (1A)。与此相比，市电通常为 230V（北美为 120V，日本为 100V），可为消耗 30A 的设备提供电力。

有许多执行器可以做到这一点，包括可以连接到现有开关的机械设备，模仿手指打开它们。最流行的是继电器。

### 继电器

继电器是一种机电开关，可将电信号转换为打开开关的机械运动。继电器的核心是电磁铁。

> 🎓 [电磁体](https://wikipedia.org/wiki/Electromagnet) 是通过将电流穿过线圈而产生的磁铁。当通电时，线圈被磁化。当电源关闭时，线圈失去磁性。

![打开时，电磁铁产生磁场，打开输出电路的开关](../../../../images/relay-on.png)

在继电器中，控制电路为电磁体供电。当电磁体打开时，它会拉动一个杠杆来移动开关，闭合一对触点并完成输出电路。

![关闭时，电磁铁不会产生磁场，关闭输出电路的开关](../../../../images/relay-off.png)

当控制电路关闭时，电磁铁关闭，释放杠杆并打开触点，关闭输出电路。继电器是数字执行器 - 继电器的高信号将其打开，低信号将其关闭。

输出电路可用于为额外的硬件供电，例如灌溉系统。物联网设备可以打开继电器，完成为灌溉系统供电的输出电路，植物得到浇水。然后物联网设备可以关闭继电器，切断灌溉系统的电源，关闭水源。

![继电器打开，打开泵将水输送到植物](../../../../images/strawberry-pump.gif)

在上面的视频中，继电器已打开。继电器上的 LED 亮起表示其已打开（某些继电器板上有 LED 来指示继电器是否打开或关闭），并向泵发送电源，打开泵并将水泵入植物中。

> 💁 继电器还可用于在两个输出电路之间进行切换，而不是打开和关闭一个输出电路。当杠杆移动时，它将开关从完成一个输出电路移动到完成另一个输出电路，通常共享公共电源连接或公共接地连接。

✅ 做一些研究：继电器有多种类型，其差异例如控制电路在通电时是否打开或关闭继电器，或者多个输出电路。了解这些不同的类型。

当控制杆移动时，您通常可以听到它与电磁体接触并发出清晰的咔嗒声。

> 💁 可以对继电器进行接线，这样连接实际上会断开继电器的电源，关闭继电器，然后向继电器发送电源，再次将其重新打开，依此类推。这意味着继电器会以令人难以置信的速度发出嗡嗡声。这就是电动门铃中使用的一些最早的蜂鸣器的工作原理。

### 继电器电源

电磁体不需要大量电力来激活和拉动控制杆，可以使用物联网开发套件的 3.3V 或 5V 输出进行控制。输出电路可以承载更多的功率，具体取决于继电器，包括电源电压甚至工业用途的更高功率水平。这样，物联网开发套件就可以控制灌溉系统，从单个植物的小型泵到整个商业农场的大型工业系统。

![带有控制电路、输出电路和继电器标签的 Grove 继电器](../../../../images/grove-relay-labelled.png)

上图显示了 Grove 继电器。控制电路连接到 IoT 设备并使用 3.3V 或 5V 打开或关闭继电器。输出电路有两个端子，其中一个可以是电源，也可以是地。输出电路可处理高达 250V、10A 的电压，足以满足一系列市电供电设备的需求。您可以获得能够处理高功率水平的继电器。

![通过继电器接线的泵](../../../../images/pump-wired-to-relay.png)

在上图中，通过继电器向泵供电。有一根红线将USB电源的+5V端子连接到继电器输出电路的一个端子，另一根红线将输出电路的另一个端子连接到泵。一根黑线将泵连接至 USB 电源的接地端。当继电器打开时，它会完成电路，向泵发送 5V 电压，从而打开泵。

## 控制继电器

您可以从 IoT 开发套件控制继电器。

### 任务 - 控制继电器

完成相关指南以使用 IoT 设备控制继电器：

* [Arduino - Wio 终端](../wio-terminal-relay.md)
* [单板计算机-Raspberry Pi](../pi-relay.md)
* [单板机-虚拟设备](../virtual-device-relay.md)

## 通过 MQTT 控制您的工厂

到目前为止，您的继电器由物联网设备直接根据单个土壤湿度读数进行控制。在商业灌溉系统中，控制逻辑将是集中的，允许它使用来自多个传感器的数据做出浇水决策，并允许在一个地方更改任何配置。为了模拟这一点，您可以通过 MQTT 控制继电器。

### 任务 - 通过 MQTT 控制中继

1. 将相关的 MQTT 库/pip 包和代码添加到 `soil-moisture-sensor` 项目中以连接到 MQTT。将客户端 ID 命名为 `soilmoisturesensor_client` ，并加上您的 ID 前缀。

    > ⚠️需要的可以参考[项目1第4课 将您的物联网设备连接到mqtt的说明](../../../../1-getting-started/lessons/4-connect-internet/README.md#connect-your-iot-device-to-mqtt) 。

1. 添加相关设备代码以发送带有土壤湿度设置的遥测数据。对于遥测消息，将属性命名为 `soil_moisture` 。

    > ⚠️ 需要的话可以参考[项目1第4课中 从您的物联网设备发送遥测到MQTT的说明](../../../../1-getting-started/lessons/4-connect-internet/README.md#send-telemetry-from-your-iot-device) 。

1. 创建一些本地服务器代码来订阅遥测并发送命令来控制名为   `soil-moisture-sensor-server` 的文件夹中的继电器。在命令消息中将该属性命名为  `relay_on` ，并将客户端 ID 设置为 `soilmoisturesensor_server` ，并以您的 ID 为前缀。保持与您为第 4 课项目 1 编写的服务器代码相同的结构，因为您将在本课稍后添加到此代码中。

    > ⚠️ 如果需要可以参考[MQTT发送遥测数据说明](../../../../1-getting-started/lessons/4-connect-internet/README.md#write-the-server-code)）和第 4 课 项目 1 中的[通过 MQTT 发送命令](../../../1-getting-started/lessons/4-connect-internet/README.md#send-commands-to-the-mqtt-broker)）。

1. 使用消息中的`relay_on` 属性添加相关设备代码以根据接收到的命令控制继电器。如果 `soil_moisture` 大于 450，则发送 `relay_on` 为 true，否则发送 false，与您之前为 IoT 设备添加的逻辑相同。

    > ⚠️如有需要，可以参考[项目1第4课中MQTT响应命令说明](../../../../1-getting-started/lessons/4-connect-internet/README.md#handle-commands-on-the-iot-device)。

> 💁 您可以在 [code-mqtt](./code-mqtt) 文件夹中找到此代码。

确保代码在您的设备和本地服务器上运行，并通过更改土壤湿度水平来测试它，可以通过更改虚拟传感器发送的值，或者通过添加水或移除传感器来更改土壤湿度水平来自土壤。

## 传感器和执行器时序

回到第 3 课，您构建了一个夜灯 - 一种 LED，一旦光传感器检测到弱光，它就会打开。光传感器立即检测到光照水平的变化，并且设备能够快速响应，仅受 `loop` 函数或`while True:` 循环中的延迟长度的限制。作为物联网开发人员，您不能总是依赖如此快速的反馈循环。

### 土壤湿度的时间

如果您使用物理传感器完成了有关土壤湿度的最后一课，您会注意到在给植物浇水后，土壤湿度读数需要几秒钟的时间才会下降。这并不是因为传感器速度慢，而是因为水浸透土壤需要时间。

> 💁 如果浇水距离传感器太近，您可能会看到读数快速下降，然后又上升 - 这是由于传感器附近的水扩散到土壤的其余部分，从而减少了传感器的土壤湿度。

![土壤湿度测量值为 658，在浇水期间不会发生变化，只有在浇水后水浸透土壤时才会降至 320](../../../../images/soil-moisture-travel.png)

在上图中，土壤湿度读数显示为 658。植物已浇水，但该读数不会立即改变，因为水尚未到达传感器。浇水甚至可以在水到达传感器之前完成，并且值下降以反映新的湿度水平。

如果您正在编写代码通过基于土壤湿度水平的继电器来控制灌溉系统，则需要考虑到这种延迟，并在您的物联网设备中构建更智能的计时。

✅ 花点时间思考一下你可以如何做到这一点。

### 控制传感器和执行器时序

想象一下，您的任务是为农场建造灌溉系统。根据土壤类型，所种植植物的理想土壤湿度水平与 400-450 的模拟电压读数相匹配。

您可以按照与夜灯相同的方式对设备进行编程 - 当传感器读数始终高于 450 时，打开继电器以打开泵。问题是水需要一段时间才能从泵中通过土壤到达传感器。当传感器检测到水位为 450 时，传感器将停止供水，但随着泵送的水不断渗入土壤，水位将继续下降。最终结果是浪费水，并有根部受损的风险。

✅ 请记住 - 太多的水和太少的水一样对植物有害，并且会浪费宝贵的资源。

更好的解决方案是了解执行器打开和传感器读取的属性变化之间存在延迟。这意味着传感器不仅需要等待一段时间才能再次测量值，而且执行器也需要关闭一段时间才能进行下一次传感器测量。

继电器每次应该接通多长时间？最好谨慎行事，只打开继电器一小段时间，然后等待水浸透，然后重新检查湿度水平。毕竟，您随时可以再次打开它以添加更多的水，但您无法从土壤中除去水。

> 💁 这种时序控制非常特定于您正在构建的物联网设备、您正在测量的属性以及所使用的传感器和执行器。

！[草莓植物通过泵连接到水，泵连接到继电器。植物中的继电器和土壤湿度传感器都连接到 Raspberry Pi](../../../../images/strawberry-with-pump.png)

例如，我有一个草莓植物，带有土壤湿度传感器和由继电器控制的泵。我观察到，当我加水时，土壤湿度读数大约需要 20 秒才能稳定。这意味着我需要关闭继电器并等待 20 秒，然后再检查湿度水平。我宁愿水太少也不愿水太多——我总是可以再次打开水泵，但我无法将水从工厂中取出。

![第一步，测量。第2步，加水。第三步，等待水浸透土壤。步骤4，重新测量](../../../../images/soil-moisture-delay.png)

这意味着最好的过程是浇水循环，如下所示：

* 打开泵5秒
* 等待 20 秒
* 检查土壤湿度
* 如果水平仍然高于我需要的水平，请重复上述步骤

5 秒对于泵来说可能太长，特别是当湿度水平仅略高于所需水平时。了解使用时机的最佳方法是尝试一下，然后在获得传感器数据时进行调整，并使用恒定的反馈循环。这甚至可以导致更精细的计时，例如每高于所需土壤湿度 100 秒就打开泵 1 秒，而不是固定的 5 秒。

✅ 做一些研究：还有其他时间考虑因素吗？土壤湿度太低时可以随时给植物浇水吗？或者一天中是否有特定的时间给植物浇水？

> 💁 在控制户外种植的自动浇水系统时，也可以考虑天气预报。如果预计会下雨，则可以暂停浇水，直到雨停后再浇水。那时土壤可能足够潮湿，不需要浇水，这比在下雨前浇水浪费水要有效得多。

## 添加定时到您的工厂控制服务器

可以修改服务器代码以添加对浇水周期时间的控制，并等待土壤湿度水平发生变化。服务器控制中继时序的逻辑为：

1. 收到遥测消息
1.检查土壤湿度
1. 如果没问题，什么也不做。如果读数太高（意味着土壤湿度太低），则：
    1. 发送命令打开继电器
    1. 等待5秒
    1. 发送命令关闭继电器
    1. 等待 20 秒，让土壤湿度稳定

浇水周期，即从接收遥测消息到准备再次处理土壤湿度水平的过程，大约需要 25 秒。我们每 10 秒发送一次土壤湿度水平，因此在服务器等待土壤湿度水平稳定时接收消息的位置会存在重叠，这可能会启动另一个浇水周期。

有两个选项可以解决此问题：

* 将 IoT 设备代码更改为每分钟仅发送遥测数据，这样浇水周期将在发送下一条消息之前完成
* 在浇水周期期间取消订阅遥测

对于大型农场来说，第一个选择并不总是一个好的解决方案。农民可能希望在土壤浇水时捕获土壤湿度水平以供以后分析，例如了解农场不同区域的水流以指导更有针对性的浇水。第二个选项更好 - 代码只是在无法使用遥测数据时忽略它，但对于可能订阅它的其他服务来说，遥测数据仍然存在。

> 💁 IoT 数据不会仅从一台设备发送到一个服务，而是许多设备可以将数据发送到代理，并且许多服务可以监听代理的数据。例如，一项服务可以监听土壤湿度数据并将其存储在数据库中以供日后分析。另一项服务也可以监听相同的遥测数据来控制灌溉系统。

### 任务 - 向工厂控制服务器添加计时

更新您的服务器代码以运行中继 5 秒，然后等待 20 秒。

1. 如果尚未打开，请在 VS Code 中打开 `soil-moisture-sensor-server` 文件夹。确保虚拟环境已激活。

1. 打开 `app.py` 文件

1. 将以下代码添加到现有导入下方的 `app.py` 文件中：

    ```python
    import threading
    ```

    该语句从Python库中导入 `threading` ，线程允许Python在等待时执行其他代码。

1. 在处理服务器代码接收到的遥测消息的 `handle_telemetry` 函数之前添加以下代码：

    ```python
    water_time = 5
    wait_time = 20
    ```

    这定义了继电器运行多长时间（`water_time` ），以及之后等待多长时间检查土壤湿度（`wait_time` ）。

1. 在此代码下方添加以下内容：

    ```python
    def send_relay_command(client, state):
        command = { 'relay_on' : state }
        print("Sending message:", command)
        client.publish(server_command_topic, json.dumps(command))
    ```

    此代码定义了一个名为 `send_relay_command` 的函数，该函数通过 MQTT 发送命令来控制继电器。遥测数据创建为字典，然后转换为 JSON 字符串。传递到 `state` 的值确定继电器应该打开还是关闭。

1. 在 `send_relay_code` 函数后面添加以下代码：

    ```python
    def control_relay(client):
        print("Unsubscribing from telemetry")
        mqtt_client.unsubscribe(client_telemetry_topic)
    
        send_relay_command(client, True)
        time.sleep(water_time)
        send_relay_command(client, False)
    
        time.sleep(wait_time)
    
        print("Subscribing to telemetry")
        mqtt_client.subscribe(client_telemetry_topic)
    ````

    这定义了一个根据所需时序控制继电器的函数。首先取消订阅遥测，以便在浇水时不会处理土壤湿度消息。接下来，它发送一条命令来打开继电器。然后，它会等待 `water_time` ，然后发送关闭继电器的命令。最后，它等待土壤湿度稳定`wait_time`  秒。然后它重新订阅遥测。

1. 将 `handle_telemetry` 函数更改为以下内容：

    ```python
    def handle_telemetry(client, userdata, message):
        payload = json.loads(message.payload.decode())
        print("Message received:", payload)
    
        if payload['soil_moisture'] > 450:
            threading.Thread(target=control_relay, args=(client,)).start()
    ```

    该代码检查土壤湿度。如果大于 450，则土壤需要浇水，因此调用`control_relay` 函数。该函数在单独的线程上运行，在后台运行。

1. 确保您的 IoT 设备正在运行，然后运行此代码。改变土壤湿度并观察继电器发生的情况 - 它应该打开 5 秒，然后保持关闭至少 20 秒，仅在土壤湿度不足时才打开。

    ```output
    (.venv) ➜  soil-moisture-sensor-server ✗ python app.py
    Message received: {'soil_moisture': 457}
    Unsubscribing from telemetry
    Sending message: {'relay_on': True}
    Sending message: {'relay_on': False}
    Subscribing to telemetry
    Message received: {'soil_moisture': 302}
    ```

    在模拟灌溉系统中测试这一点的一个好方法是使用干燥的土壤，然后在继电器打开时手动倒入水，当继电器关闭时停止浇注。

> 💁 您可以在 [code-timing](../../code-timing) 文件夹中找到此代码。

> 💁 如果你想用水泵搭建一个真正的灌溉系统，那么你可以使用[6V水泵](https://www.seeedstudio.com/6V-Mini-Water-Pump-p-1945.html) 配有[USB端子电源](https://www.adafruit.com/product/3628)。确保泵的电源是通过继电器连接的。

---

## 🚀 挑战

您能想到任何其他物联网或其他电气设备也有类似的问题吗？执行器的结果需要一段时间才能到达传感器。您的家里或学校里可能有一对。

* 它们衡量什么属性？
* 执行器使用后，属性需要多长时间发生变化？
* 属性可以更改超过要求的值吗？
* 如果需要的话如何返回到需要的值？

## 课后测验

[课后测验](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/14)

## 复习与自学

* 在 [中继维基百科页面](https://wikipedia.org/wiki/Relay) 上了解有关中继的更多信息，包括其在电话交换机中的历史使用。

## 作业

[建立更高效的浇水循环](../assignment.md)