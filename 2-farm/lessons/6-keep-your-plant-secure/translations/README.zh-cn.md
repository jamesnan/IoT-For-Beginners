
# 确保您的工厂安全

![本课的 sketchnote 概述](../../../../sketchnotes/lesson-10.jpg)

> [Nitya Narasimhan](https://github.com/nitya) 的草图笔记。单击图像可查看更大的版本。

## 课前测验

[课前测验](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/19)

## 介绍

在过去的几节课程中，您创建了土壤监测 IoT 设备并将其连接到云。但是，如果为竞争对手农民工作的黑客设法控制了您的物联网设备怎么办？如果他们发送的土壤湿度读数很高，因此您的植物从未得到浇水，或者打开您的浇水系统一直运行，导致您的植物因过度浇水而死亡并损失了您一大笔水，该怎么办？

在本课程中，您将学习如何保护物联网设备。由于这是该项目的最后一课，您还将学习如何清理云资源，降低任何潜在成本。

在本课中，我们将介绍：

* [为什么需要保护物联网设备？](#why-do-you-need-to-secure-iot-devices)
* [密码学](#密码学)
* [保护您的物联网设备](#secure-your-iot-devices)
* [生成并使用 X.509 证书](#generate-and-use-an-x.509-certificates)

> 🗑 这是本项目的最后一课，因此完成本课和作业后，不要忘记清理您的云服务。您将需要服务来完成任务，因此请务必先完成任务。
>
> 如有必要，请参阅[清理项目指南](../../../../clean-up.md)，了解如何执行此操作的说明。

## 为什么需要保护物联网设备？

IoT 安全涉及确保只有预期的设备可以连接到您的云 IoT 服务并向其发送遥测数据，并且只有您的云服务可以向您的设备发送命令。物联网数据也可以是个人数据，包括医疗或私密数据，因此您的整个应用程序需要考虑安全性以阻止这些数据被泄露。

如果您的物联网应用程序不安全，则会存在许多风险：

* 假冒设备可能会发送不正确的数据，导致您的应用程序响应不正确。例如，他们可以发送持续的高土壤湿度读数，这意味着您的灌溉系统永远不会打开，您的植物会因缺水而死亡
* 未经授权的用户可以从物联网设备读取数据，包括个人或业务关键数据
* 黑客可能会发送命令来控制设备，从而可能损坏设备或连接的硬件
* 通过连接到物联网设备，黑客可以利用它访问其他网络以访问私有系统
* 恶意用户可以访问个人数据并利用其进行勒索

这些都是现实世界的场景，并且一直在发生。前面的课程中已经给出了一些示例，但这里还有更多示例：

* 2018 年，黑客利用鱼缸恒温器上的开放 WiFi 接入点访问赌场网络来窃取数据。 [黑客新闻 - 赌场通过联网鱼缸温度计遭到黑客攻击](https://thehackernews.com/2018/04/iot-hacking-thermometer.html)
* 2016 年，Mirai 僵尸网络对互联网服务提供商 Dyn 发起拒绝服务攻击，导致大部分互联网瘫痪。该僵尸网络使用恶意软件连接到使用默认用户名和密码的 DVR 和摄像机等 IoT 设备，并从那里发起攻击。 [卫报 - 专家称，破坏互联网的 DDoS 攻击是历史上规模最大的此类攻击](https://www.theguardian.com/technology/2016/oct/26/ddos-attack-dyn-mirai-botnet)
* Spiral Toys 拥有一个通过互联网公开提供的 CloudPets 连接玩具的用户数据库。 [Troy Hunt - 连接的 CloudPets 泰迪熊的数据泄露并被勒索，暴露了孩子们的语音消息](https://www.troyhunt.com/data-from-connected-cloudpets-teddy-bears-leaked-and-ransomed-exposing-kids-voice-messages/) 。
* Strava 标记您跑过的跑步者并显示他们的路线，让陌生人可以有效地看到您住在哪里。 [Kim Komndo - 健身应用程序可能会引导陌生人到您家 - 更改此设置](https://www.komando.com/security-privacy/strava-fitness-app-privacy/755349/)。

✅ 做一些研究：搜索更多物联网黑客和物联网数据泄露的示例，尤其是连接互联网的牙刷或体重秤等个人物品。想想这些黑客可能对受害者或客户产生的影响。

> 💁 安全性是一个很大的话题，本课程将仅涉及有关将设备连接到云的一些基础知识。其他不会涉及的主题包括监视传输中的数据更改、直接攻击设备或设备配置的更改。 IoT 黑客攻击是一种威胁，已经开发了 [Azure Defender for IoT](https://azure.microsoft.com/services/azure-defender-for-iot/?WT.mc_id=academic-17441-jabenn) 等工具。这些工具类似于您计算机上可能拥有的防病毒和安全工具，只是为小型、低功耗的物联网设备设计的。

## 密码学

当设备连接到 IoT 服务时，它使用 ID 来识别自己。问题是这个 ID 可以被克隆 - 黑客可以设置一个恶意设备，该设备使用与真实设备相同的 ID，但发送虚假数据。

![有效和恶意设备都可以使用相同的 ID 发送遥测数据](../../../../images/iot-device-and-hacked-device-connecting.png)

解决这个问题的方法是将发送的数据转换为加扰格式，使用某种值来加扰仅设备和云已知的数据。此过程称为“加密”，用于加密数据的值称为“加密密钥”。

![如果使用加密，则仅接受加密消息，其他消息将被拒绝](../../../../images/iot-device-and-hacked-device-connecting-encryption.png)

然后，云服务可以使用称为“解密”的过程，使用相同的加密密钥或“解密密钥”，将数据转换回可读格式。如果加密的消息无法通过密钥解密，则设备已被黑客攻击，消息将被拒绝。

进行加密和解密的技术称为“密码学”。

### 早期密码学

最早的密码学类型是替代密码，其历史可以追溯到 3,500 年前。替换密码涉及用一个字母替换另一个字母。例如，[凯撒密码](https://wikipedia.org/wiki/Caesar_cipher) 涉及将字母表移动指定的数量，只有加密消息的发送者和预期的接收者知道要移动多少个字母。

[维吉尼亚密码](https://wikipedia.org/wiki/Vigenère_cipher) 进一步通过使用单词来加密文本，以便原始文本中的每个字母都移动不同的量，而不是总是移动相同的量字母的数量。

密码学的用途非常广泛，例如保护古代美索不达米亚的陶工釉料配方，在印度书写秘密情书，或者保守古埃及魔法咒语的秘密。

### 现代密码学

现代密码学更加先进，比早期的方法更难破解。现代密码学使用复杂的数学来使用太多可能的密钥来加密数据，从而使暴力攻击成为可能。

密码学以多种不同的方式用于安全通信。如果您在 GitHub 上阅读此页面，您可能会注意到网站地址以 *HTTPS* 开头，这意味着您的浏览器和 GitHub Web 服务器之间的通信是加密的。如果有人能够读取您的浏览器和 GitHub 之间流动的互联网流量，他们将无法读取加密的数据。您的计算机甚至可能会对硬盘驱动器上的所有数据进行加密，因此如果有人窃取它，没有您的密码，他们将无法读取您的任何数据。

> 🎓 HTTPS 代表超文本传输​​协议 **安全**

不幸的是，并非一切都是安全的。有些设备没有安全性，其他设备则使用易于破解的密钥来保护，有时甚至同一类型的所有设备都使用相同的密钥。有些非常个人化的物联网设备帐户都使用相同的密码通过 WiFi 或蓝牙连接到它们。如果您可以连接到自己的设备，则也可以连接到其他人的设备。连接后，您可以访问一些非常私密的数据，或控制他们的设备。

> 💁 尽管现代密码学非常复杂，并且声称破解加密可能需要数十亿年，但量子计算的兴起使得在很短的时间内破解所有已知加密成为可能！

### 对称和非对称密钥

加密有两种类型——对称和非对称。

**对称**加密使用相同的密钥来加密和解密数据。发送者和接收者都需要知道相同的密钥。这是最不安全的类型，因为需要以某种方式共享密钥。对于发送者要向接收者发送加密消息，发送者可能必须首先向接收者发送密钥。

![对称密钥加密使用相同的密钥来加密和解密消息](../../../../images/send-message-symmetric-key.png)

如果密钥在传输过程中被盗，或者发送者或接收者遭到黑客攻击而密钥被发现，则加密可以被破解。

![只有当黑客没有获得密钥时，对称密钥加密才是安全的 - 如果是这样，他们就可以拦截并解密消息](../../../../images/send-message-sym-key-hacker. .png）

**非对称**加密使用 2 个密钥 - 加密密钥和解密密钥，称为公钥/私钥对。公钥用于加密消息，但不能用于解密；私钥用于解密消息，但不能用于加密。

![非对称加密使用不同的密钥来加密和解密。加密密钥会发送给任何消息发送者，以便他们可以在将消息发送给拥有密钥的接收者之前对消息进行加密](../../../../images/send-message-symmetric-key-hacker.png)

接收者共享他们的公钥，发送者使用它来加密消息。消息发送后，收件人将使用其私钥对其进行解密。非对称加密更安全，因为私钥由接收者保密并且从不共享。任何人都可以拥有公钥，因为它只能用于加密消息。

对称加密比非对称加密更快，非对称更安全。有些系统会同时使用两者——使用非对称加密来加密和共享对称密钥，然后使用对称密钥来加密所有数据。这使得发送者和接收者之间共享对称密钥更加安全，并且加密和解密数据时速度更快。

## 保护您的物联网设备

可以使用对称或非对称加密来保护物联网设备。对称更容易，但安全性较差。

### 对称密钥

当您设置 IoT 设备以与 IoT 中心交互时，您使用了连接字符串。连接字符串示例如下：

```output
HostName=soil-moisture-sensor.azure-devices.net;DeviceId=soil-moisture-sensor;SharedAccessKey=Bhry+ind7kKEIDxubK61RiEHHRTrPl7HUow8cEm/mU0=
```

该连接字符串由以分号分隔的三个部分组成，每个部分都有一个键和一个值：

| Key | Value | Description |
| --- | ----- | ----------- |
| HostName | `soil-moisture-sensor.azure-devices.net` | The URL of the IoT Hub |
| DeviceId | `soil-moisture-sensor` | The unique ID of the device |
| SharedAccessKey | `Bhry+ind7kKEIDxubK61RiEHHRTrPl7HUow8cEm/mU0=` | A symmetric key known by the device and the IoT Hub |

该连接字符串的最后一部分“SharedAccessKey”是设备和 IoT 中心都知道的对称密钥。此密钥永远不会从设备发送到云端，或从云端发送到设备。相反，它用于加密发送或接收的数据。

✅ 做一个实验。如果您在连接 IoT 设备时更改连接字符串的“SharedAccessKey”部分，您认为会发生什么？试试看。

当设备首次尝试连接时，它会发送一个共享访问签名 (SAS) 令牌，其中包含 IoT 中心的 URL、访问签名将过期的时间戳（通常是当前时间后 1 天）和签名。此签名由 URL 和使用连接字符串中的共享访问密钥加密的到期时间组成。

IoT 中心使用共享访问密钥解密此签名，如果解密的值与 URL 和到期时间匹配，则允许设备连接。它还验证当前时间是否在到期之前，以阻止恶意设备捕获真实设备的 SAS 令牌并使用它。

这是验证发送者是否是正确设备的优雅方法。通过以解密和加密形式发送一些已知数据，服务器可以通过确保解密加密数据时的结果与发送的解密版本匹配来验证设备。如果匹配，则发送方和接收方都具有相同的对称加密密钥。

> 💁 由于过期时间，您的 IoT 设备需要知道准确的时间，通常从 [NTP](https://wikipedia.org/wiki/Network_Time_Protocol) 服务器读取。如果时间不准确，连接将会失败。

连接后，从设备发送到 IoT 中心或从 IoT 中心发送到设备的所有数据都将使用共享访问密钥进行加密。

✅ 如果多个设备共享相同的连接字符串，您认为会发生什么？

> 💁 将此密钥存储在代码中是不好的安全实践。如果黑客获得了您的源代码，他们就可以获得您的密钥。发布代码也更困难，因为您需要使用每个设备的更新密钥重新编译。最好从硬件安全模块加载此密钥 - 物联网设备上的芯片，用于存储可由您的代码读取的加密值。
>
> 在学习 IoT 时，将密钥放入代码中通常更容易，就像您在前面的课程中所做的那样，但您必须确保此密钥不会签入公共源代码控制中。

设备有 2 个按键和 2 个相应的连接字符串。这允许您轮换密钥 - 即如果第一个密钥被泄露，则从一个密钥切换到另一个密钥，并重新生成第一个密钥。

### X.509 证书

当您使用带有公钥/私钥对的非对称加密时，您需要向任何想要向您发送数据的人提供您的公钥。问题是，密钥的接收者如何确定它确实是您的公钥，而不是其他冒充您的密钥？您可以在已由受信任的第三方验证的证书（称为 X.509 证书）内提供公钥，而不是提供密钥。

X.509 证书是包含公钥/私钥对的公钥部分的数字文档。它们通常由称为[证书颁发机构](https://wikipedia.org/wiki/Certificate_authority) (CA) 的多个受信任组织之一颁发，并由 CA 进行数字签名，以表明密钥有效且来自您。您信任该证书，并且公钥来自证书所说的发件人，因为您信任 CA，就像您信任护照或驾驶执照，因为您信任颁发它的国家/地区一样。证书需要花钱，因此您也可以“自签名”，即自己创建一个由您签名的证书，用于测试目的。

> 💁 您永远不应该将自签名证书用于生产版本。

这些证书中有许多字段，包括公钥来自谁、颁发该证书的 CA 的详细信息、有效期限以及公钥本身。在使用证书之前，最好通过检查该证书是否由原始 CA 签名来验证它。

✅ 您可以在 [Microsoft 了解 X.509 公钥证书教程](https://docs.microsoft.com/azure/iot-hub/tutorial-x509-certificates?WT) 中阅读证书中字段的完整列表.mc_id=academic-17441-jabenn#证书字段）

使用 X.509 证书时，发送者和接收者都将拥有自己的公钥和私钥，并且都拥有包含公钥的 X.509 证书。然后，他们以某种方式交换 X.509 证书，使用彼此的公钥来加密他们发送的数据，并使用他们自己的私钥来解密他们接收的数据。

![您可以共享证书，而不是共享公钥。证书的用户可以通过与签署证书的证书颁发机构核实来验证它是否来自您。](../../../../images/send-message-certificate.png)

使用 X.509 证书的一大优点是它们可以在设备之间共享。您可以创建一个证书，将其上传到 IoT 中心，然后将其用于所有设备。然后，每个设备只需要知道私钥即可解密从 IoT 中心收到的消息。

设备用于加密发送到 IoT 中心的消息的证书由 Microsoft 发布。它与许多 Azure 服务使用的证书相同，有时内置于 SDK 中

> 💁 请记住，公钥就是公开的。 Azure 公钥只能用于加密发送到 Azure 的数据，而不能用于解密，因此可以在任何地方共享，包括在源代码中。例如，您可以在[Azure IoT C SDK源代码](https://github.com/Azure/azure-iot-sdk-c/blob/master/certs/certs.c)中看到它。

✅ X.509 证书有很多行话。您可以在 [X.509 证书术语外行指南](https://techcommunity.microsoft.com/t5/internet-of-things/the-layman-s) 中阅读您可能遇到的一些术语的定义-x-509-证书术语指南/ba-p/2203540?WT.mc_id=academic-17441-jabenn)

## 生成并使用 X.509 证书

生成 X.509 证书的步骤是：

1. 创建公钥/私钥对。生成公钥/私钥对的最广泛使用的算法之一称为 [Rivest–Shamir–Adleman](https://wikipedia.org/wiki/RSA_(cryptosystem))(RSA)。

1. 提交公钥以及相关数据以供 CA 或自签名进行签名

Azure CLI 具有用于在 IoT 中心创建新设备标识、自动生成公钥/私钥对并创建自签名证书的命令。

> 💁 如果您想查看详细步骤，而不是使用 Azure CLI，可以在 [Microsoft IoT Hub 文档中使用 OpenSSL 创建自签名证书教程](https://docs.microsoft.com/azure/iot-hub/tutorial-x509-self-sign?WT.mc_id=academic-17441-jabenn)

### 任务 - 使用 X.509 证书创建设备身份

1. 运行以下命令注册新的设备身份，自动生成密钥和证书：

    ```sh
    az iot hub device-identity create --device-id soil-moisture-sensor-x509 \
                                      --am x509_thumbprint \
                                      --output-dir . \
                                      --hub-name <hub_name>
    ```

    替换 `<hub_name>` 为您用于 IoT 中心的名称。

    这将创建一个 ID 为 `soil-moisture-sensor-x509` 的设备，以区别于您在上一课中创建的设备标识。此命令还将在当前目录中创建 2 个文件：

    * `soil-moisture-sensor-x509-key.pem` - 此文件包含设备的私钥。
    * `soil-moisture-sensor-x509-cert.pem` - 这是设备的 X.509 证书文件。

    确保这些文件安全！私钥文件不应签入公共源代码控制。

### 任务 - 在您的设备代码中使用 X.509 证书

完成相关指南，使用 X.509 证书将 IoT 设备连接到云：

* [Arduino - Wio 终端](../wio-terminal-x509.md)
* [单板计算机-Raspberry Pi/虚拟物联网设备](../single-board-computer-x509.md)

---

## 🚀 挑战

有多种方法可以创建、管理和删除 Azure 服务，例如资源组和 IoT 中心。一种方法是 [Azure 门户](https://portal.azure.com?WT.mc_id=academic-17441-jabenn) - 一个基于 Web 的界面，为你提供一个 GUI 来管理 Azure 服务。

前往 [portal.azure.com](https://portal.azure.com?WT.mc_id=academic-17441-jabenn) 并调查该门户。查看是否可以使用门户创建 IoT 中心，然后将其删除。

**提示** - 通过门户创建服务时，您不需要预先创建资源组，可以在创建服务时创建一个资源组。完成后请务必将其删除！

您可以在 [Azure 门户文档](https://docs.microsoft.com/azure/azure-portal/?WT.mc_id=academic-17441-jabenn) 中找到有关 Azure 门户的大量文档、教程和指南。

## 课后测验

[课后测验](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/20)

## 复习与自学

* 在[维基百科上的密码学历史页面](https://wikipedia.org/wiki/History_of_cryptography) 上阅读密码学的历史。
* 在 [Wikipedia 上的 X.509 页面](https://wikipedia.org/wiki/X.509) 上阅读 X.509 证书。

## 作业

[构建新的物联网设备](../assignment.md)

    
   