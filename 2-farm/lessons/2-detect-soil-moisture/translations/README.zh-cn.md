
# 检测土壤湿度

![本课的 sketchnote 概述](../../../../sketchnotes/lesson-6.jpg)

> [Nitya Narasimhan](https://github.com/nitya) 的草图笔记。单击图像可查看更大的版本。

本课程是 [Microsoft Reactor](https://developer.microsoft.com) 的 [IoT 初学者项目 2 - 数字农业系列](https://youtube.com/playlist?list=PLmsFUfdnGr3yCutmcVg6eAUEfsGiFXgcx) 的一部分/reactor/?WT.mc_id=academic-17441-jabenn)。

[![土壤湿度传感器和数字农业](https://img.youtube.com/vi/ZzpTu3x4c6M/0.jpg)](https://youtu.be/ZzpTu3x4c6M)

## 课前测验

[课前测验](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/11)

## 介绍

在上一课中，我们研究了测量环境特性并用它来预测植物生长。温度是可以控制的，但这样做的成本很高，需要受控的环境。对植物来说，最容易控制的环境属性是水——从大型灌溉系统到用喷壶给花园浇水的小孩子，每天都需要控制水。

![一个孩子在花园里浇水](../../../../images/child-watering-garden.jpg)

在本课程中，您将学习如何测量土壤湿度，在下一课程中，您将学习如何控制自动浇水系统。本课程介绍第三个传感器，您已经使用了光传感器、温度传感器，因此在本课程中您还将了解更多有关传感器和执行器如何与物联网设备通信的信息，以了解更多有关土壤湿度传感器如何发送数据的信息到物联网设备。

在本课中，我们将介绍：

* [土壤湿度](#soil-moisture)
* [传感器如何与物联网设备通信](#how-sensors-communicate-with-iot-devices)
* [测量土壤湿度](#measure-the-moisture-levels-in-soil)
* [传感器校准](#sensor-calibration)

## 土壤湿度

植物需要水才能生长。它们吸收整个植物的水分，其中大部分被根系吸收。植物将水用于三件事：

* [光合作用](https://wikipedia.org/wiki/Photosynthesis) - 植物与水、二氧化碳和光发生化学反应，产生碳水化合物和氧气。
* [蒸腾作用](https://wikipedia.org/wiki/Transpiration) - 植物利用水将空气中的二氧化碳通过叶子上的气孔扩散到植物中。这个过程还将营养物质带到植物周围，并使植物冷却，类似于人类出汗的方式。
* 结构 - 植物也需要水来维持其结构 - 它们的 90% 是水（而人类只有 60%），而这些水使细胞保持刚性。如果植物没有足够的水，它就会枯萎并最终死亡。

![水通过植物根吸收，然后携带到植物周围，用于光合作用和植物结构](../../../../images/transpiration.png)

✅ 做一些研究：通过蒸腾作用损失了多少水？

根系通过植物生长的土壤中的水分提供水分。土壤中的水太少，植物无法吸收足够的生长所需的水，太多的水，根部无法吸收足够的氧气来发挥作用。这会导致根部死亡，植物无法获得足够的营养来生存。

为了使农民获得最佳的植物生长，土壤不能太湿也不能太干。物联网设备可以通过测量土壤湿度来帮助解决这个问题，让农民只在需要时浇水。

### 测量土壤湿度的方法

您可以使用多种不同类型的传感器来测量土壤湿度：

* 电阻式 - 电阻式传感器有 2 个插入土壤的探头。电流被发送到一个探头，并被另一个探头接收。然后传感器测量土壤的电阻 - 测量第二个探头处的电流下降量。水是电的良导体，因此土壤含水量越高，电阻越低。

    ![电阻式土壤湿度传感器](../../../../images/resistive-soil-moisture-sensor.png)

    > 💁 您可以使用两块相距几厘米的金属（例如钉子）构建电阻式土壤湿度传感器，并使用万用表测量它们之间的电阻。

* 电容式 - 电容式湿度传感器测量正极板和负极板可存储的电荷量，或[电容](https://wikipedia.org/wiki/Capacitance)。土壤的电容随着湿度的变化而变化，这可以转换为可由物联网设备测量的电压。土壤越湿，产生的电压越低。

    ![电容式土壤湿度传感器](../../../../images/grove-capacitive-soil-moisture-sensor.png)

这些都是模拟传感器，返回电压来指示土壤湿度。那么这个电压是如何到达你的代码的呢？在进一步了解这些传感器之前，让我们先看看传感器和执行器如何与物联网设备通信。

## 传感器如何与物联网设备通信

到目前为止，在这些课程中，您已经了解了许多传感器和执行器，如果您一直在进行物理硬件实验室，那么这些传感器和执行器一直在与您的物联网开发套件进行通信。但这种沟通是如何进行的呢？土壤湿度传感器的电阻测量结果如何变成可以通过代码使用的数字？

要与大多数传感器和执行器通信，您需要一些硬件和通信协议 - 这是一种定义明确的数据发送和接收方式。以电容式土壤湿度传感器为例：

* 该传感器如何连接到物联网设备？
* 如果它测量的是模拟信号电压，则需要 ADC 来创建该值的数字表示形式，并且该值作为交流电压发送以发送 0 和 1 - 但每个位发送多长时间？
* 如果传感器返回一个数字值，那将是一个 0 和 1 的流，那么每个位发送多长时间？
* 如果电压高0.1s是单个1位，还是连续2个1位，还是10个？
* 数字从什么时候开始？`00001101` 是 25，还是前 5 位是前一个值的末尾？

硬件提供发送数据的物理连接，不同的通信协议确保以正确的方式发送或接收数据，以便可以解释数据。

### 通用输入输出 (GPIO) 引脚

GPIO 是一组可用于将硬件连接到 IoT 设备的引脚，并且通常在 Raspberry Pi 或 Wio Terminal 等 IoT 开发套件上提供。您可以通过 GPIO 引脚使用本节中介绍的各种通信协议。一些 GPIO 引脚提供电压，通常为 3.3V 或 5V，一些引脚接地，其他引脚可以通过编程设置为发送电压（输出）或接收电压（输入）。

> 💁 电路需要通过您使用的任何电路将电压连接到地。您可以将电压视为电池的正极 (+ve) 端子，将接地视为负极 (-ve) 端子。

当您只关心开或关值（开称为高，关称为低）时，您可以直接将 GPIO 引脚与某些数字传感器和执行器一起使用。一些例子是：

* 按钮。您可以在 5V 引脚和设置为输入的引脚之间连接一个按钮。当您按下按钮时，它会在 5V 引脚之间形成一个电路，通过按钮到输入引脚。从代码中，您可以读取输入引脚上的电压，如果它为高（5V），则按钮被按下，如果它为低（0v），则按钮未被按下。请记住，实际电压本身不会被读取，而是根据电压是否高于阈值而获得 1 或 0 的数字信号。

    ![按钮发送 5 伏电压。未按下时返回 0 伏或 0，按下时返回 5 伏或 1](../../../../images/button-with-digital.png)

* 引领。您可以在输出引脚和接地引脚之间连接一个 LED（使用电阻，否则会烧坏 LED）。从代码中，您可以将输出引脚设置为高电平，它将发送 3.3V 电压，从而形成一个从 3.3V 引脚通过 LED 到接地引脚的电路。这将点亮 LED。

    ![向 LED 发送 0 (3.3V) 信号，该信号点亮 LED。如果发送0（0v），则LED不亮。](../../../../images/led-digital-control.png)

对于更高级的传感器，您可以使用 GPIO 引脚直接通过数字传感器和执行器发送和接收数字数据，或者通过带有 ADC 和 DAC 的控制器板与模拟传感器和执行器通信。

> 💁 如果您在这些实验室中使用 Raspberry Pi，Grove Base Hat 具有可将模拟传感器信号转换为数字信号以通过 GPIO 发送的硬件。

✅ 如果您有带有 GPIO 引脚的 IoT 设备，请找到这些引脚并找到一个图表，指示哪些引脚是电压引脚、接地引脚或可编程引脚。

### 模拟引脚

某些设备（例如 Arduino 设备）提供模拟引脚。这些引脚与 GPIO 引脚相同，但它们不仅支持数字信号，还具有 ADC 将电压范围转换为数值。通常 ADC 具有 10 位分辨率，这意味着它将电压转换为 0-1,023 的值。

例如，在 3.3V 板上，如果传感器返回 3.3V，则返回值将为 1,023。如果返回的电压为1.65v，则返回的值为511。

![土壤湿度传感器发送 3.3V 电压并返回 1.65V，或读数为 511](../../../../images/analog-sensor-Voltage.png)

> 💁 回到夜光 - 第 3 课，光传感器返回 0-1,023 之间的值。如果您使用的是 Wio 终端，则传感器已连接到模拟引脚。如果您使用的是 Raspberry Pi，则传感器连接到底座上的模拟引脚，该底座具有集成 ADC，可通过 GPIO 引脚进行通信。虚拟设备设置为发送 0-1,023 之间的值来模拟模拟引脚。

土壤湿度传感器依赖于电压，因此将使用模拟引脚并给出 0-1,023 之间的值。

### 内部集成电路 (I 2 C)

I 2 C，发音为*I-squared-C*，是一种多控制器、多外设协议，任何连接的设备都能够充当控制器或外设，通过 I 2 C 总线（通信系统的名称）进行通信传输数据）。数据作为寻址数据包发送，每个数据包都包含其目标连接设备的地址。

> 💁 该模型曾经被称为主/从，但由于与奴隶制相关，该术语正在被删除。[开源硬件协会已采用控制器/外设](https://www.oshwa.org/a-redefine-spi-signal-names/)，但您可能仍然会看到对旧术语的引用。
设备具有连接到 I 2 C 总线
时使用的地址，并且通常硬编码在设备上。例如，Seeed 的每种类型的 Grove 传感器都具有相同的地址，因此所有光传感器都具有相同的地址，所有按钮都具有与光传感器地址不同的相同地址。有些设备可以通过更改跳线设置或将引脚焊接在一起来更改地址。

I 2 C 有一条由 2 条主线和 2 条电源线组成的总线：

| 电线| 名称 | 描述 |
| ---- | --------- | ----------- |
| SDA | 串行数据| 该线用于在设备之间发送数据。|
| SCL | 串行时钟| 该线以控制器设定的速率发送时钟信号。|
| VCC | 电压公共集电极| 设备的电源。它连接到 SDA 和 SCL 线，通过上拉电阻提供电源，当没有设备作为控制器时，上拉电阻会关闭信号。|
| 接地 | 地面| 这为电路提供了公共接地。|

![I2C总线有3个设备连接到SDA和SCL线，共享公共地线](../../../../images/i2c.png)

为了发送数据，一台设备将发出一个启动条件以表明它已准备好发送数据。然后它将成为控制器。然后，控制器发送它想要与之通信的设备的地址，以及是否想要读取或写入数据。数据传输完毕后，控制器发送停止条件以表明传输已完成。此后，另一个设备可以成为控制器并发送或接收数据。

I 2 C 有速度限制，有 3 种不同的模式以固定速度运行。最快的是高速模式，最高速度为 3.4Mbps（兆位每秒），但很少有设备支持该速度。例如，Raspberry Pi 仅限于 400Kbps（千位每秒）的快速模式。标准模式以 100Kbps 运行。

> 💁 如果您使用带有 Grove Base hat 的 Raspberry Pi 作为 IoT 硬件，您将能够在板上看到许多 I 2 C 插座，可用于与 I 2 C 传感器进行通信。Analog Grove 传感器还使用 I 2 C 和 ADC 将模拟值作为数字数据发送，因此您使用的光传感器模拟模拟引脚，并通过 I 2 C 发送值，因为 Raspberry Pi 仅支持数字引脚。

### 通用异步接收器-发送器 (UART)

UART 涉及允许两个设备进行通信的物理电路。每个设备都有 2 个通信引脚 - 发送 (Tx) 和接收 (Rx)，第一个设备的 Tx 引脚连接到第二个设备的 Rx 引脚，第二个设备的 Tx 引脚连接到第二个设备的 Rx 引脚。第一的。这允许双向发送数据。

* 设备 1 从其 Tx 引脚发送数据，设备 2 在其 Rx 引脚上接收数据
* 设备 1 在其 Rx 引脚上接收由设备 2 从其 Tx 引脚发送的数据

![UART，一个芯片上的 Tx 引脚连接到另一芯片上的 Rx 引脚，反之亦然](../../../../images/uart.png)

> 🎓 数据一次发送一位，这称为*串行*通信。大多数操作系统和微控制器都有“串行端口”，即可以发送和接收代码可用的串行数据的连接。

UART 设备有一个波特率（https://wikipedia.org/wiki/Symbol_rate）（也称为符号率），它是每秒发送和接收数据的速度。常见的波特率为 9,600，这意味着每秒发送 9,600 位（0 和 1）数据。

UART 使用起始位和停止位 - 也就是说，它发送一个起始位来指示它将发送一个字节（8 位）数据，然后在发送 8 位后发送一个停止位。

UART 速度取决于硬件，但即使是最快的实现也不会超过 6.5 Mbps（每秒发送兆位，或每秒发送数百万位，0 或 1）。

您可以通过 GPIO 引脚使用 UART - 您可以将一个引脚设置为 Tx，将另一个引脚设置为 Rx，然后将它们连接到另一台设备。

> 💁 如果您使用带有 Grove Base hat 的 Raspberry Pi 作为 IoT 硬件，您将能够在板上看到 UART 插座，您可以使用它与使用 UART 协议的传感器进行通信。

### 串行外设接口 (SPI)

SPI 设计用于短距离通信，例如在微控制器上与闪存等存储设备通信。它基于控制器/外设模型，其中单个控制器（通常是物联网设备的处理器）与多个外设交互。控制器通过选择外围设备并发送或请求数据来控制一切。

> 💁 与 I 2 C 一样，术语“控制器”和“外设”是最近的更改，因此您可能会看到仍在使用旧术语。

SPI 控制器使用 3 条线，每个外设还使用 1 条额外线。外围设备使用 4 根线。这些电线是：

| 电线| 名称 | 描述 |
| ---- | --------- | ----------- |
| 科普 | 控制器输出、外围输入| 该线用于将数据从控制器发送到外设。|
| 加拿大知识产权局 | 控制器输入，外围输出| 该线用于将数据从外设发送到控制器。|
| SCLK | 串行时钟| 该线以控制器设定的速率发送时钟信号。|
| 计算机科学 | 片选| 控制器有多条线，每个外设一根，每条线连接到相应外设上的 CS 线。|

![带有控制器和两个外设的 SPI](../../../../images/spi.png)

CS 线用于一次激活一个外设，通过 COPI 和 CIPO 线进行通信。当控制器需要更改外设时，它会停用连接到当前活动外设的 CS 线，然后激活连接到下一个要与之通信的外设的线。

SPI 是*全双工*，这意味着控制器可以使用 COPI 和 CIPO 线路同时从同一外设发送和接收数据。SPI 使用 SCLK 线上的时钟信号来保持设备同步，因此与直接通过 UART 发送不同，它不需要启动位和停止位。

SPI 没有定义的速度限制，其实现通常能够每秒传输数兆字节的数据。

IoT 开发套件通常通过某些 GPIO 引脚支持 SPI。例如，在 Raspberry Pi 上，您可以将 GPIO 引脚 19、21、23、24 和 26 用于 SPI。

### 无线的

一些传感器可以通过标准无线协议进行通信，例如蓝牙（主要是蓝牙低功耗，或 BLE）、LoRaWAN（一种 **Lo**ng **Ra**nge 低功耗网络协议）或 WiFi。这些允许远程传感器未物理连接到物联网设备。

商业土壤湿度传感器就是这样的一个例子。这些设备将测量田间的土壤湿度，然后通过 LoRaWan 将数据发送到集线器设备，集线器设备将处理数据或通过互联网发送数据。这使得传感器可以远离管理数据的物联网设备，从而降低功耗以及对大型 WiFi 网络或长电缆的需求。

BLE 在高级传感器（例如手腕上的健身追踪器）中很受欢迎。它们结合了多个传感器，并通过 BLE 将传感器数据以手机的形式发送到物联网设备。

✅ 您身上、家里或学校里有蓝牙传感器吗？这些可能包括温度传感器、占用传感器、设备跟踪器和健身设备。

Zigbee 是商业设备连接的一种流行方式。Zigbee 使用 WiFi 在设备之间形成网状网络，其中每个设备都连接到尽可能多的附近设备，形成像蜘蛛网一样的大量连接。当一台设备想要向互联网发送消息时，它可以将其发送到最近的设备，然后设备将其转发到附近的其他设备，依此类推，直到消息到达协调器并可以发送到互联网。

> 🐝 Zigbee 这个名字指的是蜜蜂返回蜂巢后的摇摆舞。

## 测量土壤湿度

您可以使用土壤湿度传感器、物联网设备以及室内植物或附近的土壤来测量土壤的湿度。

### 任务 - 测量土壤湿度

阅读相关指南，使用 IoT 设备测量土壤湿度：

* [Arduino - Wio 终端](../wio-terminal-soil-moisture.md)
* [单板计算机-Raspberry Pi](../pi-soil-moisture.md)
* [单板机-虚拟设备](../virtual-device-soil-moisture.md)

## 传感器校准

传感器依赖于测量电阻或电容等电气特性。

> 🎓 电阻，以欧姆 (Ω) 为单位测量，是指流过某物的电流受到的阻力有多大。当电压施加到材料上时，通过材料的电流量取决于材料的电阻。您可以在[维基百科上的电阻页面](https://wikipedia.org/wiki/Electrical_resistance_and_conductance) 上阅读更多信息。

> 🎓 电容，以法拉 (F) 为单位测量，是组件或电路收集和存储电能的能力。您可以在[维基百科上的电容页面](https://wikipedia.org/wiki/Capacitance) 上阅读有关电容的更多信息。

这些测量值并不总是有用 - 想象一下温度传感器为您提供 22.5KΩ 的测量值！相反，测量值需要通过校准转换为有用的单位 - 即将测量值与测量数量相匹配，以便将新测量值转换为正确的单位。

有些传感器已预先校准。例如，您在上一课中使用的温度传感器已经过校准，因此它可以返回以 °C 为单位的温度测量值。在工厂中，创建的第一个传感器将暴露在一系列已知温度下并测量电阻。然后，这将用于构建计算，可以将 Ω（电阻单位）测量值转换为 °C。

> 💁 根据温度计算电阻的公式称为 [Steinhart–Hart 方程](https://wikipedia.org/wiki/Steinhart–Hart_equation)。

### 土壤湿度传感器校准

土壤湿度使用重量或体积含水量来测量。

* 重力是测量的单位重量土壤中水的重量，即每千克干土壤中水的千克数
* 体积是测量的单位体积土壤中的水体积，即每立方米干燥土壤的立方米水数

> 🇺🇸 对于美国人来说，由于单位的一致性，可以用磅而不是公斤来衡量，或者用立方英尺而不是立方米来衡量。

土壤湿度传感器测量电阻或电容 - 这不仅会因土壤湿度而变化，还会因土壤类型而变化，因为土壤中的成分会改变其电气特性。理想情况下，传感器应该进行校准 - 即从传感器获取读数并将其与使用更科学的方法找到的测量结果进行比较。例如，实验室可以使用每年多次采集的特定田地样本来计算重力土壤湿度，这些数字用于校准传感器，将传感器读数与重力土壤湿度相匹配。

![电压与土壤水分含量的关系图](../../../../images/soil-moisture-to-Voltage.png)

上图显示了如何校准传感器。捕获土壤样品的电压，然后在实验室中通过比较湿重与干重（通过测量湿重，然后在烤箱中干燥并测量干重）来测量电压。一旦获取了一些读数，就可以将其绘制在图表上并绘制一条适合这些点的线。然后，该线路可用于将物联网设备获取的土壤湿度传感器读数转换为实际的土壤湿度测量值。

💁 对于电阻式土壤湿度传感器，电压随着土壤湿度的增加而增加。对于电容式土壤湿度传感器，电压随着土壤湿度的增加而降低，因此这些图表将向下倾斜，而不是向上倾斜。

![从图表中插值的土壤湿度值](../../../../images/soil-moisture-to-voltage-with-reading.png)

上图显示了土壤湿度传感器的电压读数，通过跟踪图中的线，可以计算出实际的土壤湿度。

这种方法意味着农民只需要对田地进行一些实验室测量，然后他们就可以使用物联网设备来测量土壤湿度 - 大大加快了测量时间。

---

## 🚀 挑战

电阻式和电容式土壤湿度传感器有许多差异。这些差异是什么？哪种类型（如果有）最适合农民使用？这个答案在发展中国家和发达国家之间是否有变化？

## 课后测验

[课后测验](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/12)

## 复习与自学

了解传感器和执行器使用的硬件和协议：

* [GPIO 维基百科页面](https://wikipedia.org/wiki/General- Purpose_input/output)
* [UART 维基百科页面](https://wikipedia.org/wiki/Universal_asynchronous_receiver-transmitter)
* [SPI 维基百科页面](https://wikipedia.org/wiki/Serial_Peripheral_Interface)
* [I 2 C 维基百科页面](https://wikipedia.org/wiki/I²C)
* [Zigbee 维基百科页面](https://wikipedia.org/wiki/Zigbee)

## 作业

[校准你的传感器](../assignment.md)
