
# 从 IoT 设备检查库存

![本课的 sketchnote 概述](../../../../sketchnotes/lesson-20.jpg)

> [Nitya Narasimhan](https://github.com/nitya) 的草图笔记。单击图像查看放大版本。

## 课前测验

[课前测验](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/39)

## 介绍

在上一课中，您了解了零售业中对象检测的不同用途。您还学习了如何训练物体检测器来识别库存。在本课程中，您将学习如何使用物联网设备中的物体检测器来盘点库存。

在本课中，我们将介绍：

* [库存盘点](#stock-counting)
* [从 IoT 设备调用对象检测器](#call-your-object-detector-from-your-iot-device)
* [边界框](#bounding-boxes)
* [重新训练模型](#retrain-the-model)
* [清点库存](#count-stock)

> 🗑 这是本项目的最后一课，因此完成本课和作业后，不要忘记清理您的云服务。您将需要服务来完成任务，因此请务必先完成任务。
>
> 如有必要，请参阅[清理项目指南](../../../../clean-up.md)，了解如何执行此操作的说明。

## 库存盘点

物体探测器可用于库存检查，清点库存或确保库存位于应有的位置。带有摄像头的物联网设备可以部署在商店各处来监控库存，从重新进货很重要的热点开始，例如库存少量高价值商品的区域。

例如，如果摄像机对准一组可容纳 8 罐番茄酱的架子，而物体检测器仅检测到 7 罐，则缺少一罐，需要重新进货。

![架子上有 7 罐番茄酱，顶行 4 罐，顶部 3 罐](../../../../images/stock-7-cans-tomato-paste.png)

在上图中，物体检测器在可容纳 8 罐的架子上检测到 7 罐番茄酱。物联网设备不仅可以发送需要补货的通知，甚至可以指示丢失物品的位置，如果您使用机器人补货货架，这是重要的数据。

> 💁 根据商店和商品的受欢迎程度，如果只有 1 罐丢失，可能不会进行补货。您需要构建一个算法，根据您的产品、客户和其他标准确定何时补货。

✅ 在哪些其他场景中您可以将物体检测和机器人结合起来？

有时货架上的库存可能是错误的。这可能是补货时的人为错误，或者顾客改变购买想法并将商品放回第一个可用空间。当这是罐头食品等不易腐烂的物品时，这是一种烦恼。如果它是易腐烂的物品，例如冷冻或冷藏物品，这可能意味着该产品无法再销售，因为可能无法判断该物品从冰箱中取出了多长时间。

物体检测可用于检测意外物品，一旦检测到物品，就会再次提醒人类或机器人归还物品。

![番茄酱架上的一罐流氓玉米宝宝](../../../../images/stock-rogue-corn.png)

在上图中，一罐小玉米被放在番茄酱旁边的架子上。物体检测器已检测到这一点，从而允许物联网设备通知人类或机器人将罐子返回到正确的位置。

## 从 IoT 设备调用对象检测器

您可以从 IoT 设备调用您在上一课中训练的对象检测器。

### 任务 - 发布对象检测器的迭代

迭代是从自定义视觉门户发布的。

1. 在 [CustomVision.ai](https://customvision.ai) 上启动 Custom Vision 门户，如果尚未打开，请登录。然后打开您的“stock- detector”项目。

1. 从顶部的选项中选择 **性能** 选项卡

1. 从侧面的 *Iterations* 列表中选择最新的迭代

1. 选择迭代的**发布**按钮

    ![发布按钮](../../../../images/custom-vision-object-detector-publish-button.png)

1. 在“发布模型”对话框中，将“预测资源”设置为您在上一课中创建的“stock- detector-prediction”资源。将名称保留为“Iteration2”，然后选择“**发布**”按钮。

1. 发布后，选择 **预测 URL** 按钮。这将显示预测 API 的详细信息，您将需要这些信息才能从 IoT 设备调用模型。下部标记为*如果您有图像文件*，这就是您想要的详细信息。复制显示的 URL，如下所示：

    ```output
    https://<location>.api.cognitive.microsoft.com/customvision/v3.0/Prediction/<id>/detect/iterations/Iteration2/image
    ```
    

    `location` 将是您在创建自定义视觉资源时使用的位置，并且 `id` 将是一个由字母和数字组成的长 ID。

    另请复制 *Prediction-Key* 值。这是调用模型时必须传递的安全密钥。只有通过此密钥的应用程序才允许使用该模型，任何其他应用程序都会被拒绝。

    ![显示 URL 和密钥的预测 API 对话框](../../../../images/custom-vision-prediction-key-endpoint.png)

✅ 当发布新的迭代时，它将有不同的名称。您认为如何改变物联网设备正在使用的迭代？

### 任务 - 从 IoT 设备调用对象检测器

请按照以下相关指南从 IoT 设备使用对象检测器：

* [Arduino - Wio 终端](../wio-terminal-object-detector.md)
* [单板计算机-Raspberry Pi/虚拟设备](../single-board-computer-object-detector.md)

## 边界框

当您使用对象检测器时，您不仅可以获取检测到的对象及其标签和概率，还可以获取对象的边界框。 这些定义了对象检测器以给定概率检测到对象的位置。

> 💁 边界框是定义包含检测到的对象的区域的框，定义对象边界的框。

自定义视觉中的 **预测** 选项卡中的预测结果在发送用于预测的图像上绘制了边界框。

![货架上的 4 罐番茄酱，预测 4 次检测结果分别为 35.8%、33.5%、25.7% 和 16.6%](../../../../images/custom-vision-stock-prediction.png)

在上图中，检测到 4 罐番茄酱。 在结果中，图像中检测到的每个对象都会覆盖一个红色方块，表示图像的边界框。

✅ 在自定义视觉中打开预测并检查边界框。

边界框由 4 个值定义 - 顶部、左侧、高度和宽度。 这些值的范围为 0-1，将位置表示为图像大小的百分比。 原点（0,0 位置）是图像的左上角，因此顶部值是距顶部的距离，边界框的底部是顶部加上高度。

![一罐番茄酱周围的边界框](../../../../images/bounding-box.png)

上面的图像宽 600 像素，高 800 像素。 边界框从下方 320 像素开始，顶部坐标为 0.4 (800 x 0.4 = 320)。 从左侧开始，边界框的宽度为 240 像素，左坐标为 0.4 (600 x 0.4 = 240)。 边界框的高度为 240 像素，高度值为 0.3 (800 x 0.3 = 240)。 边界框的宽度为 120 像素，宽度值为 0.2 (600 x 0.2 = 120)。

| 坐标| 价值|
| ---------- | ----: |
| 顶部 | 0.4 | 0.4
| 左| 0.4 | 0.4
| 身高| 0.3 | 0.3
| 宽度| 0.2 | 0.2

使用 0-1 之间的百分比值意味着无论图像缩放到什么尺寸，边界框都从沿线和向下的 0.4 处开始，高度为 0.3，宽度为 0.2。

您可以将边界框与概率结合使用来评估检测的准确度。 例如，物体检测器可以检测重叠的多个物体，例如检测一个罐子在另一个罐子里面。 您的代码可以查看边界框，了解这是不可能的，并忽略与其他对象有显着重叠的任何对象。

![两个粘合盒重叠一罐番茄酱](../../../../images/overlap-object-detection.png)

在上面的示例中，一个边界框表明一罐番茄酱的预测率为 78.3%。 第二个边界框稍小，并且位于第一个边界框内的概率为 64.3%。 您的代码可以检查边界框，查看它们完全重叠，并忽略较低的概率，因为一个边界框不可能位于另一个边界框内。
✅ 你能想到一种情况，在这种情况下，检测一个物体位于另一个物体内是有效的吗？

## 重新训练模型

与图像分类器一样，您可以使用 IoT 设备捕获的数据重新训练模型。使用这些真实数据将确保您的模型在物联网设备上使用时运行良好。

与图像分类器不同，您不能只标记图像。相反，您需要检查模型检测到的每个边界框。如果该框周围有错误的东西，则需要将其删除，如果它位于错误的位置，则需要进行调整。

### 任务 - 重新训练模型

1. 确保您已使用 IoT 设备捕获了一系列图像。

1. 从 **预测** 选项卡中，选择一个图像。您将看到红色框，指示检测到的对象的边界框。

1. 遍历每个边界框。首先选择它，您将看到一个显示标签的弹出窗口。如有必要，请使用边界框角上的手柄调整大小。如果标签错误，请使用 **X** 按钮将其删除并添加正确的标签。如果边界框不包含对象，请使用垃圾桶按钮将其删除。

1. 完成后关闭编辑器，图像将从 **预测** 选项卡移至 **训练图像** 选项卡。对所有预测重复该过程。

1. 使用 **训练** 按钮重新训练您的模型。训练完成后，发布迭代并更新您的 IoT 设备以使用新迭代的 URL。

1. 重新部署您的代码并测试您的 IoT 设备。

## 清点库存

使用检测到的对象数量和边界框的组合，您可以计算货架上的库存。

### 任务 - 清点库存

请按照以下相关指南，使用 IoT 设备中的物体检测器的结果来盘点库存：

* [Arduino - Wio 终端](../wio-terminal-count-stock.md)
* [单板计算机-Raspberry Pi/虚拟设备](../single-board-computer-count-stock.md)

---

## 🚀 挑战

你能检测到错误的库存吗？在多个对象上训练您的模型，然后更新您的应用程序，以便在检测到错误库存时向您发出警报。

甚至可以更进一步，检测同一货架上并排的库存，并通过定义边界框的限制来查看是否有东西被放置在错误的位置。

## 课后测验

[课后测验](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/40)

## 复习与自学

* 通过 [Microsoft Docs 上的边缘模式指南缺货检测](https://docs.microsoft.com/hybrid/app-solutions/pattern-out-of-stock-at-edge?WT.mc_id=academic-17441-jabenn) 了解有关如何构建端到端库存检测系统的更多信息
* 通过观看 YouTube 上的视频] [零售解决方案的幕后 - 动手实践！](https://www.youtube.com/watch?v=m3Pc300x2Mw)， 了解构建结合了一系列物联网和云服务的端到端零售解决方案的其他方法。.
  
## 任务

[在边缘使用物体检测器](../assignment.md)

      
     
    
   