
# 训练库存检测器

![本课的 sketchnote 概述](../../../../sketchnotes/lesson-19.jpg)

> [Nitya Narasimhan](https://github.com/nitya) 的草图笔记。单击图像查看放大版本。

本视频概述了 Azure 自定义视觉服务的对象检测，该服务将在本课程中介绍。

[![Custom Vision 2 - 物体检测变得简单 | Xamarin 秀](https://img.youtube.com/vi/wtTYSyBUpFc/0.jpg)](https://www.youtube.com/watch?v=wtTYSyBUpFc)

> 🎥 点击上图观看视频

## 课前测验

[课前测验](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/37)

## 介绍

在上一个项目中，您使用 AI 训练图像分类器，该模型可以判断图像中是否包含某些内容，例如成熟的水果或未成熟的水果。另一种可用于图像的人工智能模型是对象检测。这些模型不会通过标签对图像进行分类，而是经过训练来识别对象，并且可以在图像中找到它们，不仅检测图像是否存在，还检测它在图像中的位置。这允许您计算图像中的对象。

在本课程中，您将学习对象检测，包括如何在零售业中使用它。您还将学习如何在云中训练对象检测器。

在本课中，我们将介绍：

* [物体检测](#物体检测)
* [在零售中使用对象检测](#use-object-detection-in-retail)
* [训练物体检测器](#train-an-object- detector)
* [测试你的物体检测器](#test-your-object- detector)
* [重新训练你的物体检测器](#retrain-your-object- detector)

## 物体检测

对象检测涉及使用人工智能检测图像中的对象。与您在上一个项目中训练的图像分类器不同，对象检测不是预测整个图像的最佳标签，而是查找图像中的一个或多个对象。

### 对象检测与图像分类

图像分类是将图像作为一个整体进行分类——整个图像与每个标签匹配的概率是多少。您可以获得用于训练模型的每个标签的概率。

![腰果和番茄酱的图像分类](../../../../images/image-classifier-cashews-tomato.png)

在上面的示例中，使用经过训练的模型对两幅图像进行分类，该模型经过训练可以对一桶腰果或一罐番茄酱进行分类。第一张图像是一桶腰果，图像分类器有两个结果：

|标签 |概率|
| -------------- | ----------: |
| `腰果` | 98.4% |
| `番茄酱` | 1.6% |

第二张图片是一罐番茄酱，结果是：

|标签 |概率|
| -------------- | ----------: |
| `腰果` | 0.7% |
| `番茄酱` | 99.3% |

您可以使用这些值和阈值百分比来预测图像中的内容。但是，如果图像包含多罐番茄酱，或者同时包含腰果和番茄酱，该怎么办？结果可能不会给你你想要的。这就是物体检测的用武之地。

对象检测涉及训练模型来识别对象。您无需向其提供包含该对象的图像并告诉它每个图像是一个标签或另一个标签，而是突出显示包含特定对象的图像部分并对其进行标记。您可以标记图像中的单个对象或多个对象。通过这种方式，模型可以了解对象本身的样子，而不仅仅是包含该对象的图像的样子。

然后，当您使用它来预测图像时，您将获得检测到的对象的列表，以及它们的边界框以及对象与分配的标签匹配的概率，而不是返回标签和百分比列表。

> 🎓 *边界框*是对象周围的框。

![腰果和番茄酱的物体检测](../../../../images/object-detector-cashews-tomato.png)

上图包含一桶腰果和三罐番茄酱。对象检测器检测到腰果，返回包含腰果的边界框，以及边界框包含对象的百分比，在本例中为 97.6%。对象检测器还检测到三罐番茄酱，并提供三个单独的边界框，每个检测到的罐子对应一个边界框，并且每个边界框具有该边界框包含一罐番茄酱的百分比概率。

✅ 考虑一些您可能想要使用基于图像的 AI 模型的不同场景。哪些需要分类，哪些需要对象检测？

### 对象检测的工作原理

对象检测使用复杂的机器学习模型。这些模型的工作原理是将图像分成多个单元，然后检查边界框的中心是否是与用于训练模型的图像之一匹配的图像的中心。您可以将其视为在图像的不同部分上运行图像分类器以查找匹配项。

> 💁 这是一个极端的过度简化。对象检测有很多技术，您可以在[维基百科上的对象检测页面](https://wikipedia.org/wiki/Object_detection) 上阅读有关它们的更多信息。

有许多不同的模型可以进行对象检测。一个特别著名的模型是 [YOLO（你只看一次）](https://pjreddie.com/darknet/yolo/)，它的速度非常快，可以检测 20 种不同类别的物体，例如人、狗、瓶子和汽车。

✅ 在 [pjreddie.com/darknet/yolo/](https://pjreddie.com/darknet/yolo/) 上阅读 YOLO 模型

可以使用迁移学习重新训练对象检测模型来检测自定义对象。

## 在零售业中使用物体检测

物体检测在零售业有多种用途。其中一些包括：

* **库存检查和盘点** - 识别货架上的库存何时不足。如果库存太少，可以向工作人员或机器人发送通知以重新上架。
* **口罩检测** - 在公共卫生事件期间有口罩政策的商店中，物体检测可以识别戴口罩和不戴口罩的人。
* **自动计费** - 检测自动商店中从货架上取下的商品并适当地向客户计费。
* **危险检测** - 识别地板上的破损物品或溢出的液体，提醒清洁人员。

✅ 做一些研究：零售业中物体检测还有哪些用例？

## 训练物体检测器

您可以使用自定义视觉来训练对象检测器，其方式与训练图像分类器的方式类似。

### 任务 - 创建一个对象检测器

1.为此项目创建一个名为`stock- detector`的资源组

1. 在`stock- detector`资源组中创建免费的自定义视觉培训资源和免费的自定义视觉预测资源。将它们命名为`库存检测器训练`和`库存检测器预测`。

    > 💁 您只能拥有一个免费的培训和预测资源，因此请确保您已清理了之前课程中的项目。

    > ⚠️ 如果需要，您可以参考[项目 4 第 1 课创建训练和预测资源的说明](../../../4-manufacturing/lessons/1-train-fruit-detector/README.md#task---create-a-cognitive-services-resource) 。

1. 通过 [CustomVision.ai](https://customvision.ai) 启动自定义视觉门户，然后使用您用于 Azure 帐户的 Microsoft 帐户登录。

1. 按照 Microsoft 文档上构建对象检测器快速入门的[创建新项目部分](https://docs.microsoft.com/azure/cognitive-services/custom-vision-service/get-started-build-detector?WT.mc_id=academic-17441-jabenn#create-a-new-project) 创建一个新的自定义视觉项目。用户界面可能会发生变化，这些文档始终是最新的参考。

    将您的项目命名为`stock- detector`。

    创建项目时，请确保使用之前创建的`stock- detector-training`资源。使用*对象检测*项目类型和*货架上的产品*域。

    ![自定义视觉项目的设置，名称设置为fruit-quality- detector，无描述，资源设置为fruit-quality- detector-training，项目类型设置为classification，分类类型设置为multi class，设置为食物的域](../../../../images/custom-vision-create-object-detector-project.png)


    ✅ 货架上的产品域专门用于检测商店货架上的库存。有关不同域的更多信息，请参阅 [在 Microsoft Docs 上选择域文档](https://docs.microsoft.com/azure/cognitive-services/custom-vision-service/select-domain?WT.mc_id=academic-17441-jabenn#object-detection)

✅ 花一些时间探索对象检测器的自定义视觉 UI。

### 任务 - 训练你的物体检测器

要训​​练模型，您将需要一组包含要检测的对象的图像。

1. 收集包含要检测的对象的图像。您将需要至少 15 个包含每个对象的图像，以便从各种不同角度和不同照明条件下进行检测，但越多越好。此对象检测器使用*货架上的产品*域，因此请尝试将对象设置为就像它们位于商店货架上一样。您还需要一些图像来测试模型。如果您要检测多个对象，您将需要一些包含所有对象的测试图像。

    > 💁 包含多个不同对象的图像计入图像中所有对象的最少 15 个图像。

    您的图像应该是 png 或 jpeg，小于 6MB。例如，如果您使用 iPhone 创建它们，它们可能是高分辨率 HEIC 图像，因此需要转换并可能缩小。图像越多越好，并且成熟和未成熟的图像数量应该相似。

    该模型是为货架上的产品设计的，因此请尝试拍摄货架上的物品的照片。

    您可以在可以使用的腰果和番茄酱的[images](../images)文件夹中找到一些可以使用的示例图像。

1. 按照 Microsoft 文档上构建对象检测器快速入门的[上传和标记图像部分](https://docs.microsoft.com/azure/cognitive-services/custom-vision-service/get-started-build-detector?WT.mc_id=academic-17441-jabenn#upload-and-tag-images) 上传您的训练图像。根据您要检测的对象类型创建相关标签。

    ![显示上传成熟和未成熟香蕉图片的上传对话框](../../../../images/image-upload-object- detector.png)

    当您为对象绘制边界框时，请使边界框保持良好且紧密地围绕对象。勾勒出所有图像的轮廓可能需要一段时间，但该工具会检测它认为的边界框，从而加快速度。

    ![标记一些番茄酱](../../../../images/object-detector-tag-tomato-paste.png)

    > 💁 如果每个对象的图像超过 15 张，您可以在 15 张图像之后进行训练，然后使用 **建议标签** 功能。这将使用经过训练的模型来检测未标记图像中的对象。然后，您可以确认检测到的对象，或拒绝并重新绘制边界框。这可以节省`大量`时间。

1. 按照 Microsoft 文档上构建对象检测器快速入门的[训练检测器部分](https://docs.microsoft.com/azure/cognitive-services/custom-vision-service/get-started-build-detector?WT.mc_id=academic-17441-jabenn#train-the-detector) 在标记图像上训练对象检测器。

    您将可以选择培训类型。选择**快速训练**。

然后物体检测器将进行训练。培训需要几分钟才能完成。

## 测试你的物体检测器

一旦你的物体检测器经过训练，你可以通过给它新的图像来检测物体来测试它。

### 任务 - 测试你的物体检测器

1. 使用 **快速测试** 按钮上传测试图像并验证是否检测到对象。使用您之前创建的测试图像，而不是用于训练的任何图像。

    ![检测到 3 罐番茄酱，概率分别为 38%、35.5% 和 34.6%](../../../../images/object-detector-Detected-tomato-paste.png)

1. 尝试您可以访问的所有测试图像并观察概率。

## 重新训练你的物体检测器

当您测试对象检测器时，它可能不会给出您期望的结果，与上一个项目中的图像分类器相同。您可以通过使用错误的图像对其进行重新训练来改进对象检测器。

每次使用快速测试选项进行预测时，都会存储图像和结果。您可以使用这些图像来重新训练您的模型。

1. 使用 **预测** 选项卡找到用于测试的图像

1. 确认所有准确的检测，删除不正确的检测并添加任何缺失的对象。

1. 重新训练并重新测试模型。

---

## 🚀 挑战

如果您将物体探测器与外观相似的物品（例如同品牌的番茄酱罐和切碎的番茄）一起使用，会发生什么？

如果您有任何看起来相似的物品，请通过将它们的图像添加到对象检测器来进行测试。

## 课后测验

[课后测验](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/38)

## 复习与自学

* 当您训练对象检测器时，您会看到 *Precision*、*​​Recall* 和 *mAP* 的值，这些值对所创建的模型进行评级。阅读 [Microsoft 文档上构建对象检测器快速入门的评估检测器部分](https://docs.microsoft.com/azure/cognitive-services/custom-vision-service/get-started-build-detector?WT.mc_id=academic-17441-jabenn#evaluate-the-detector) ，了解这些值的用途
* 在 [Wikipedia 上的对象检测页面](https://wikipedia.org/wiki/Object_detection) 上了解有关对象检测的更多信息

## 任务

[比较域](../assignment.md)