
# 通过传感器触发水果质量检测

![本课的 sketchnote 概述](../../../../sketchnotes/lesson-18.jpg)

> [Nitya Narasimhan](https://github.com/nitya) 的草图笔记。单击图像查看放大版本。

## 课前测验

[课前测验](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/35)

## 介绍

物联网应用程序不仅仅是捕获数据并将其发送到云端的单个设备，它通常是多个设备一起工作，使用传感器从物理世界捕获数据，根据该数据做出决策，并与通过执行器或可视化的物理世界。

在本课程中，您将详细了解如何构建复杂的物联网应用程序、整合多个传感器、多个云服务来分析和存储数据，以及通过执行器显示响应。您将学习如何构建水果质量控制系统原型，包括使用接近传感器触发物联网应用程序，以及该原型的架构是什么。

在本课中，我们将介绍：

* [架构复杂的物联网应用程序](#architect-complex-iot-applications)
* [设计水果质量控制系统](#design-a-fruit-quality-control-system)
* [通过传感器触发水果质量检查](#trigger-fruit-quality-checking-from-a-sensor)
* [用于水果质量检测器的数据](#data-used-for-a-fruit-quality- detector)
* [使用开发者设备模拟多个物联网设备](#using-developer-devices-to-simulate-multiple-iot-devices)
* [转向生产](#转向生产)

> 🗑 这是本项目的最后一课，因此完成本课和作业后，不要忘记清理您的云服务。您将需要服务来完成任务，因此请务必先完成任务。
>
> 如有必要，请参阅[清理项目指南](../../../../clean-up.md)，了解如何执行此操作的说明。

## 构建复杂的物联网应用程序

物联网应用程序由许多组件组成。这包括各种事物和各种互联网服务。

物联网应用程序可以被描述为`事物`（设备）发送生成`见解`的数据。这些`见解`会产生`行动`来改进业务或流程。一个例子是发送温度数据的发动机（物体）。该数据用于评估引擎是否按预期运行（洞察）。该见解用于主动确定发动机维护计划（操作）的优先级。

* 不同的事物收集不同的数据。
* 物联网服务提供对这些数据的洞察，有时会使用其他来源的数据对其进行增强。
* 这些见解驱动行动，包括控制设备中的执行器或可视化数据。

### 参考物联网架构

![参考物联网架构](../../../../images/iot-reference-architecture.png)

上图显示了参考物联网架构。

> 🎓 *参考架构* 是一个示例架构，您可以在设计新系统时用作参考。在这种情况下，如果您正在构建新的物联网系统，您可以遵循参考架构，在适当的情况下替换您自己的设备和服务。

* **事物**是从传感器收集数据的设备，可能与边缘服务交互以解释该数据，例如用于解释图像数据的图像分类器。来自设备的数据被发送到物联网服务。
* **见解** 来自无服务器应用程序，或来自对存储数据运行的分析。
* **操作** 可以是发送到设备的命令，也可以是允许人类做出决策的数据可视化。

![参考物联网架构](../../../../images/iot-reference-architecture-azure.png)

上图显示了这些课程中迄今为止涵盖的一些组件和服务，以及如何在参考物联网架构中链接在一起。

* **事物** - 您已编写设备代码来从传感器捕获数据，并使用在云端和边缘设备上运行的自定义视觉来分析图像。该数据已发送到 IoT 中心。
* **见解** - 您已使用 Azure Functions 响应发送到 IoT 中心的消息，并将数据存储在 Azure 存储中以供以后分析。
* **操作** - 您已根据云中做出的决策和发送到设备的命令控制执行器，并且您已使用 Azure Maps 可视化数据。


✅ 想想您使用过的其他物联网设备，例如智能家电。该设备及其软件涉及哪些事物、见解和操作？

此模式可以根据您的需要进行扩展或扩展，添加更多设备和更多服务。

### 数据和安全

在定义系统架构时，您需要不断考虑数据和安全性。

* 您的设备发送和接收哪些数据？
* 应如何保护这些数据？
* 应如何控制对设备和云服务的访问？

✅ 考虑您拥有的任何物联网设备的数据安全性。这些数据中有多少是个人数据，无论是在传输过程中还是在存储时都应该保密？哪些数据不应该被存储？

## 设计水果质量控制系统

现在，让我们将这种事物、见解和行动的想法应用到我们的水果质量检测器中，以设计一个更大的端到端应用程序。

想象一下，您的任务是构建一个用于加工厂的水果质量检测器。水果在传送带系统上运输，目前员工花时间手工检查水果，并在到达时清除所有未成熟的水果。为了降低成本，工厂所有者需要一个自动化系统。

✅ 物联网（以及一般技术）兴起的趋势之一是手工工作正在被机器取代。做一些研究：预计物联网将失去多少工作岗位？构建物联网设备将创造多少新就业机会？

您需要构建一个系统，在水果到达传送带时对其进行检测，然后使用在边缘运行的人工智能模型对其进行拍照和检查。然后结果被发送到云端进行存储，如果水果未成熟，则会发出通知，以便可以删除未成熟的水果。

| | |
| - | - |
| **事情** |检测到达传送带上的水果
相机对水果进行拍照和分类
边缘设备运行分类器
通知未成熟水果的设备 |
| **见解** |决定检查水果的成熟度
存储成熟度分类的结果
确定是否需要对未成熟的水果发出警报 |
| **行动** |向设备发送命令以拍摄水果并使用图像分类器进行检查
向设备发送命令以警告水果未成熟|

### 构建您的应用程序原型

![用于水果质量检查的参考物联网架构](../../../../images/iot-reference-architecture-fruit-quality.png)

上图显示了该原型应用程序的参考架构。

* 带有接近传感器的物联网设备可检测水果的到达。这会向云端发送一条消息，表示已检测到水果。
* 云中的无服务器应用程序向另一台设备发送命令以拍照并对图像进行分类。
* 带有摄像头的物联网设备拍摄照片并将其发送到在边缘运行的图像分类器。然后将结果发送到云端。
* 云中的无服务器应用程序会存储这些信息，以便稍后进行分析，以了解未成熟水果的百分比。如果水果未成熟，它会向另一个物联网设备发送命令，通过 LED 提醒工厂工人有未成熟的水果。

> 💁 整个物联网应用程序可以作为单个设备实现，并具有启动图像分类和控制内置 LED 的所有逻辑。它可以使用物联网中心来跟踪检测到的未成熟水果的数量并配置设备。在本课程中，它被扩展以演示大规模物联网应用的概念。

对于原型，您将在单个设备上实现所有这些。如果您使用微控制器，那么您将使用单独的边缘设备来运行图像分类器。您已经了解了构建此项目所需的大部分内容。

## 通过传感器触发水果质量检查

物联网设备需要某种触发器来指示水果何时可以进行分类。触发此操作的一个触发因素是通过测量到传感器的距离来测量水果何时位于传送带上的正确位置。

![接近传感器将激光束发送到香蕉等物体，并计算光束反射回来的时间](../../../../images/proximity-sensor.png)

接近传感器可用于测量传感器到物体的距离。它们通常发射电磁辐射束，例如激光束或红外光，然后检测从物体反射的辐射。发送激光束和信号反弹之间的时间可用于计算到传感器的距离。

> 💁 您可能在不知情的情况下使用过接近传感器。当您将智能手机放在耳边时，大多数智能手机都会关闭屏幕，以防止您意外地用耳垂结束通话，这使用接近传感器来工作，在通话过程中检测到靠近屏幕的物体并禁用触摸功能，直到电话有一定距离。

### 任务 - 通过距离传感器触发水果质量检测

阅读相关指南，使用接近传感器通过 IoT 设备检测物体：

* [Arduino - Wio 终端](../wio-terminal-proximity.md)
* [单板计算机-Raspberry Pi](../pi-proximity.md)
* [单板机-虚拟设备](../virtual-device-proximity.md)

## 用于水果品质检测仪的数据

水果探测器原型有多个相互通信的组件。

![组件之间相互通信](../../../../images/fruit-quality-detector-message-flow.png)

* 接近传感器测量到水果的距离并将其发送到物联网中心
* 从IoT Hub发送到摄像头设备的控制摄像头的命令
* 图像分类结果发送至IoT Hub
* 控制 LED 在水果未成熟时发出警报的命令从 IoT Hub 发送到带有 LED 的设备

在构建应用程序之前，最好预先定义这些消息的结构。

> 💁 几乎每个经验丰富的开发人员在其职业生涯的某个阶段都会花费数小时、数天甚至数周的时间来追查由于发送的数据与预期的数据差异而导致的错误。

例如，如果您要发送温度信息，您将如何定义 JSON？您可以有一个名为`温度`的字段，或者可以使用常见的缩写`temp`。

```json
{
    "temperature": 20.7
}
```

相比：

```json
{
    "temp": 20.7
}
```

您还必须考虑单位 - 温度的单位是 °C 还是 °F？如果您使用消费设备测量温度并且它们更改了显示单位，您需要确保发送到云端的单位保持一致。

✅ 做一些研究：装置问题是如何导致价值 1.25 亿美元的火星气候轨道飞行器坠毁的？

考虑一下发送给水果质量检测器的数据。您如何定义每条消息？您将在哪里分析数据并决定发送哪些数据？

例如 - 使用接近传感器触发图像分类。物联网设备测量距离，但在哪里做出决定呢？设备是否认为水果足够近并发送消息告诉 IoT 中心触发分类？或者它是否发送接近测量结果并让 IoT 中心决定？

此类问题的答案是——视情况而定。每个用例都是不同的，这就是为什么作为物联网开发人员，您需要了解您正在构建的系统、它的使用方式以及正在检测的数据。

* 如果由 IoT 中心做出决定，则需要发送多个距离测量值。
* 如果发送太多消息，则会增加 IoT 中心的成本以及 IoT 设备所需的带宽量（尤其是在拥有数百万台设备的工厂中）。它还会减慢您的设备速度。
* 如果您在设备上做出决定，您将需要提供一种配置设备的方法来微调机器。

## 使用开发者设备模拟多个物联网设备

要构建原型，您需要 IoT 开发套件像多个设备一样运行，发送遥测数据并响应命令。

### 在 Raspberry Pi 或虚拟 IoT 硬件上模拟多个 IoT 设备

当使用像 Raspberry Pi 这样的单板计算机时，您可以同时运行多个应用程序。这意味着您可以通过创建多个应用程序（每个`物联网设备`一个）来模拟多个物联网设备。例如，您可以将每个设备实现为单独的 Python 文件，并在不同的终端会话中运行它们。

> 💁 请注意，某些硬件在被同时运行的多个应用程序访问时将无法工作。

### 在微控制器上模拟多个设备

微控制器模拟多个设备更加复杂。与单板计算机不同，您无法同时运行多个应用程序，您必须将所有单独的物联网设备的所有逻辑包含在单个应用程序中。

使这个过程更容易的一些建议是：

* 为每个 IoT 设备创建一个或多个类 - 例如名为`DistanceSensor`、`ClassifierCamera`、`LEDController`的类。每个方法都可以有自己的`setup`和`loop`方法，由主`setup`和`loop`函数调用。
* 在一个地方处理命令，并根据需要将它们定向到相关的设备类。
* 在主`loop`函数中，您需要考虑每个不同设备的时序。例如，如果您有一个设备类需要每 10 秒处理一次，而另一个设备类需要每 1 秒处理一次，那么在主`loop`函数中使用 1 秒延迟。每次`loop`调用都会触发每秒需要处理的设备的相关代码，并使用计数器对每个循环进行计数，当计数器达到 10 时处理另一个设备（之后重置计数器）。

## 转向生产

该原型将构成最终生产系统的基础。当您转向生产时，一些差异是：

* 坚固耐用的组件 - 使用旨在承受工厂噪音、热量、振动和压力的硬件。
* 使用内部通信 - 某些组件将直接通信，避免跳转到云，仅将数据发送到云进行存储。如何完成此操作取决于工厂设置，可以直接通信，也可以使用网关设备在边缘运行部分物联网服务。
* 配置选项 - 每个工厂和用例都不同，因此硬件需要可配置。例如，接近传感器可能需要检测不同距离处的不同水果。您不希望对触发分类的距离进行硬编码，而是希望可以通过可以进行配置，例如使用设备孪生
* 自动水果移除 - 自动化设备会将其移除，而不是通过 LED 来提醒水果未成熟。

✅ 做一些研究：生产设备与开发工具包还有哪些其他不同之处？

---

## 🚀 挑战

在本课程中，您学习了有关如何构建物联网系统所需的一些概念。回想一下之前的项目。它们如何融入上面所示的参考架构？

选择迄今为止的一个项目，并考虑设计一个更复杂的解决方案，将超出项目涵盖范围的多种功能结合在一起。绘制架构并考虑您需要的所有设备和服务。

例如，车辆跟踪设备将 GPS 与传感器相结合，可监控冷藏车内的温度、发动机的开启和关闭时间以及驾驶员的身份等。涉及的设备、涉及的服务、传输的数据以及安全和隐私考虑因素是什么？

## 课后测验

[课后测验](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/36)

## 复习与自学

* 有关 IoT 架构的更多信息，请参阅 [Microsoft 文档上的 Azure IoT 参考架构文档](https://docs.microsoft.com/azure/architecture/reference-architectures/iot?WT.mc_id=academic-17441-jabenn)
* 在 [Microsoft 文档上的 IoT 中心文档中了解和使用设备孪生](https://docs.microsoft.com/azure/iot-hub/iot-hub-devguide-device-twins?WT) 中了解有关设备孪生的更多信息.
* 在 [Wikipedia 上的 OPC-UA 页面](https://wikipedia.org/wiki/OPC_Unified_Architecture) 上了解 OPC-UA，这是一种用于工业自动化的机器对机器通信协议

## 任务

[搭建水果品质检测仪](../taskment.md)