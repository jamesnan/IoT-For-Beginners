
# 通过物联网设备检查水果质量

![本课的 sketchnote 概述](../../../../sketchnotes/lesson-16.jpg)

> [Nitya Narasimhan](https://github.com/nitya) 的草图笔记。单击图像可查看更大的版本。

## 课前测验

[课前测验](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/31)

## 介绍

在上一课中，您了解了图像分类器，以及如何训练它们来检测好水果和坏水果。要在物联网应用程序中使用此图像分类器，您需要能够使用某种相机捕获图像，并将该图像发送到云端进行分类。

在本课程中，您将了解相机传感器，以及如何将它们与物联网设备一起使用来捕获图像。您还将了解如何从 IoT 设备调用图像分类器。

在本课中，我们将介绍：

* [相机传感器](#camera-sensors)
* [使用 IoT 设备捕获图像](#capture-an-image-using-an-iot-device)
* [发布您的图像分类器](#publish-your-image-classifier)
* [对 IoT 设备中的图像进行分类](#classify-images-from-your-iot-device)
* [改进模型](#Improve-the-model)

## 相机传感器

顾名思义，相机传感器是可以连接到物联网设备的相机。他们可以拍摄静态图像，或捕获流视频。有些将返回原始图像数据，其他则将图像数据压缩为图像文件，例如 JPEG 或 PNG。通常，与物联网设备配合使用的摄像头比您习惯的摄像头小得多，分辨率也低得多，但您可以获得可与高端手机相媲美的高分辨率摄像头。您可以获得各种可互换镜头、多种相机设置、红外热像仪或紫外线相机。

![场景中的光线穿过镜头并聚焦在 CMOS 传感器上](../../../../images/cmos-sensor.png)

大多数相机传感器使用图像传感器，其中每个像素都是光电二极管。镜头将图像聚焦到图像传感器上，数千或数百万个光电二极管检测落在每个光电二极管上的光线，并将其记录为像素数据。

> 💁 镜头反转图像，然后相机传感器将图像向右翻转回来。这在你的眼睛中也是一样的——你所看到的东西会在你的眼睛后部被颠倒地检测到，然后你的大脑会纠正它。

> 🎓 图像传感器被称为有源像素传感器 (APS)，最流行的 APS 类型是互补金属氧化物半导体传感器 (CMOS)。您可能听说过用于相机传感器的术语 CMOS 传感器。

相机传感器是数字传感器，通常在提供通信的库的帮助下将图像数据作为数字数据发送。相机使用 SPI 等协议进行连接，以允许它们发送大量数据 - 图像比温度传感器等传感器的单个数据大得多。

✅ IoT 设备的图像大小有哪些限制？考虑特别是微控制器硬件上的限制。

## 使用 IoT 设备捕获图像

您可以使用 IoT 设备捕获图像并进行分类。

### 任务 - 使用 IoT 设备捕获图像

完成相关指南以使用 IoT 设备捕获图像：

* [Arduino - Wio 终端](../wio-terminal-camera.md)
* [单板计算机-Raspberry Pi](../pi-camera.md)
* [单板机-虚拟设备](../virtual-device-camera.md)

## 发布你的图像分类器

您在上一课中训练了图像分类器。您需要先发布模型，然后才能从 IoT 设备使用它。

### 模型迭代

当您的模型在上一课中进行训练时，您可能会注意到 **性能** 选项卡在侧面显示迭代。当您第一次训练模型时，您会在训练中看到*迭代 1*。当您使用预测图像改进模型时，您会在训练中看到*迭代 2*。

每次训练模型时，您都会得到新的迭代。这是一种跟踪在不同数据集上训练的模型的不同版本的方法。当您进行**快速测试**时，您可以使用一个下拉菜单来选择迭代，以便您可以比较多个迭代的结果。

当您对迭代感到满意时，您可以发布它以供外部应用程序使用。通过这种方式，您可以拥有一个供您的设备使用的已发布版本，然后通过多次迭代开发新版本，然后在您满意后发布该版本。

### 任务 - 发布迭代

迭代是从自定义视觉门户发布的。

1. 在 [CustomVision.ai](https://customvision.ai) 上启动 Custom Vision 门户，如果尚未打开，请登录。然后打开您的“水果质量检测器”项目。

1. 从顶部的选项中选择 **性能** 选项卡

1. 从侧面的 *Iterations* 列表中选择最新的迭代

1. 选择迭代的**发布**按钮

    ![发布按钮](../../../../images/custom-vision-publish-button.png)

1. 在*发布模型*对话框中，将*预测资源*设置为您在上一课中创建的 `fruit-quality- detector-prediction` 资源。将名称保留为 `Iteration2`，然后选择“**发布**”按钮。

1. 发布后，选择 **预测 URL** 按钮。这将显示预测 API 的详细信息，您将需要这些信息才能从 IoT 设备调用模型。下部标记为*如果您有图像文件*，这就是您想要的详细信息。复制显示的 URL，如下所示：

    ```output
    https://<location>.api.cognitive.microsoft.com/customvision/v3.0/Prediction/<id>/classify/iterations/Iteration2/image
    ```

    `location` 将是您在创建自定义视觉资源时使用的位置，并且 `id` 将是一个由字母和数字组成的长 ID。

    另请复制 *Prediction-Key* 值。这是调用模型时必须传递的安全密钥。只有通过此密钥的应用程序才允许使用该模型，任何其他应用程序都会被拒绝。

    ![显示 URL 和密钥的预测 API 对话框](../../../../images/custom-vision-prediction-key-endpoint.png)

✅ 当发布新的迭代时，它将有不同的名称。您认为如何改变物联网设备正在使用的迭代？

## 对 IoT 设备中的图像进行分类

您现在可以使用这些连接详细信息从 IoT 设备调用图像分类器。

### 任务 - 对 IoT 设备中的图像进行分类

完成相关指南，使用 IoT 设备对图像进行分类：

* [Arduino - Wio 终端](../wio-terminal-classify-image.md)
* [单板计算机-Raspberry Pi/虚拟物联网设备](../single-board-computer-classify-image.md)

## 改进模型

您可能会发现，使用连接到 IoT 设备的摄像头时获得的结果与您的预期不符。预测并不总是像使用从计算机上传的图像那样准确。这是因为该模型是根据与用于预测的数据不同的数据进行训练的。

为了获得图像分类器的最佳结果，您需要使用与用于预测的图像尽可能相似的图像来训练模型。例如，如果您使用手机摄像头捕捉图像进行训练，则图像质量、清晰度和颜色将与连接到物联网设备的摄像头不同。

![2 张香蕉图片，一张是物联网设备照明条件较差的低分辨率图片，一张是手机照明条件良好的高分辨率图片](../../../../images/banana-picture-compare.png)

在上图中，左边的香蕉照片是使用 Raspberry Pi 相机拍摄的，右边的照片是使用 iPhone 在同一位置拍摄的同一个香蕉。质量上有明显的差异 - iPhone 的图像更清晰，颜色更明亮，对比度更高。

✅ 还有什么可能导致 IoT 设备捕获的图像出现错误的预测？考虑一下物联网设备可能使用的环境，哪些因素会影响捕获的图像？

要改进模型，您可以使用从 IoT 设备捕获的图像重新训练它。

### 任务 - 改进模型

1. 使用物联网设备对成熟和未成熟水果的多个图像进行分类。

1. 在自定义视觉门户中，使用*预测*选项卡上的图像重新训练模型。

    > ⚠️ 如果需要，您可以参考 [第 1 课中重新训练分类器的说明](../1-train-fruit-detector/README.md#retrain-your-image-classifier).。

1. 如果您的图像看起来与用于训练的原始图像非常不同，您可以通过在 *训练图像* 选项卡中选择它们并选择 **删除** 按钮来删除所有原始图像。要选择图像，请将光标移到该图像上，然后会出现一个勾号，选择该勾号即可选择或取消选择该图像。

1. 使用上述步骤训练模型的新迭代并发布它。

1. 更新代码中的端点 URL，然后重新运行应用程序。

1. 重复这些步骤，直到您对预测结果感到满意为止。

---

## 🚀 挑战

图像分辨率或光照对预测的影响有多大？

尝试更改设备代码中图像的分辨率，看看它是否会对图像质量产生影响。还可以尝试改变照明。

如果您要创建一种生产设备出售给农场或工厂，您将如何确保它始终提供一致的结果？

## 课后测验

[课后测验](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/32)

## 复习与自学

您使用门户训练了自定义视觉模型。这依赖于可用的图像 - 在现实世界中，您可能无法获得与设备上的相机捕获的数据相匹配的训练数据。您可以通过使用训练 API 直接从设备进行训练来解决此问题，从而使用从 IoT 设备捕获的图像来训练模型。

* 阅读 [使用自定义视觉 SDK 快速入门](https://docs.microsoft.com/azure/cognitive-services/custom-vision-service/quickstarts/image-classification?WT.mc_id=academic-17441-jabenn&tabs=visual-studio&pivots=programming-language-python)


## 任务

[回应分类结果](../assignment.md)

      
     
    
   