
# 位置追踪

![本课的 sketchnote 概述](../../../../sketchnotes/lesson-11.jpg)

> [Nitya Narasimhan](https://github.com/nitya) 的草图笔记。单击图像可查看更大的版本。

## 课前测验

[课前测验](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/21)

## 介绍

将食物从农民送到消费者手中的主要过程包括将一箱箱农产品装载到卡车、轮船、飞机或其他商业运输车辆上，然后将食物运送到某个地方 - 直接运送给客户，或者运送到中央枢纽或仓库进行加工。从农场到消费者的整个端到端流程是 `供应链` 流程的一部分。下面来自亚利桑那州立大学 WP Carey 商学院的视频讨论了供应链的概念以及如何更详细地管理它。

[![什么是供应链管理？来自亚利桑那州立大学 WP Carey 商学院的视频](https://img.youtube.com/vi/Mi1QBxVjZAw/0.jpg)](https://www.youtube.com/watch?v=Mi1QBxVjZAw)

> 🎥 点击上图观看视频

添加物联网设备可以极大地改善您的供应链，使您能够管理物品的位置、更好地计划运输和货物装卸，并更快地响应问题。

在管理卡车等车队时，了解每辆车在给定时间的位置会很有帮助。车辆可以配备 GPS 传感器，将其位置发送到物联网系统，从而使车主能够精确定位其位置、查看其行驶路线并了解何时到达目的地。大多数车辆在 WiFi 覆盖范围之外运行，因此它们使用蜂窝网络发送此类数据。有时，GPS 传感器内置于更复杂的物联网设备中，例如电子日志。这些设备跟踪卡车的运输时间，以确保司机遵守当地有关工作时间的法律。

在本课程中，您将学习如何使用全球定位系统 (GPS) 传感器跟踪车辆位置。

在本课中，我们将介绍：

* [联网车辆](#connected-vehicles)
* [地理空间坐标](#地理空间坐标)
* [全球定位系统 (GPS)](#global-positioning-systems-gps)
* [读取 GPS 传感器数据](#read-gps-sensor-data)
* [NMEA GPS 数据](#nmea-gps-data)
* [解码 GPS 传感器数据](#decode-gps-sensor-data)

## 联网车辆

物联网正在通过创建 `互联车辆` 车队来改变货物运输方式。这些车辆连接到中央 IT 系统，报告其位置信息和其他传感器数据。拥有联网车辆车队具有广泛的优势：

* 位置跟踪 - 您可以随时查明车辆所在位置，从而使您能够：

  * 当车辆即将到达目的地时收到警报，以便工作人员准备卸货
  * 找到被盗车辆
  * 将位置和路线数据与交通问题相结合，以便您在旅途中重新安排车辆路线
  * 遵守税收规定。一些国家根据公共道路上行驶的里程数对车辆收费（例如[新西兰的​​ RUC](https://www.nzta.govt.nz/vehicles/licensing-rego/road-user-charges/)），因此了解车辆何时在公共道路上行驶以及何时在私人道路上行驶可以更轻松地计算所欠税款。
  * 知道发生故障时将维修人员派往何处

* 驾驶员遥测 - 能够确保驾驶员遵守速度限制、以适当的速度转弯、及早有效制动以及安全驾驶。联网车辆还可以配备摄像头来记录事件。这可以与保险挂钩，为优秀司机提供较低的费率。

* 驾驶员工作时间合规性 - 确保驾驶员仅在法律允许的时间内驾驶，具体取决于他们打开和关闭发动机的时间。

这些好处可以结合起来，例如，将驾驶员工作时间合规性与位置跟踪相结合，以便在驾驶员无法在允许的驾驶时间内到达目的地时重新安排路线。这些还可以与其他车辆特定的遥测技术相结合，例如来自温控卡车的温度数据，如果车辆当前的路线意味着货物无法保持在温度下，则可以重新安排车辆的路线。

> 🎓 物流是将货物从一个地方运输到另一个地方的过程，例如通过一个或多个仓库从农场运输到超市。农民将一箱箱西红柿装上卡车，运送到中央仓库，然后放到第二辆卡车上，其中可能装有不同类型的产品混合物，然后运送到超市。

车辆跟踪的核心组件是 GPS——可以精确定位车辆在地球上任何地方的位置的传感器。在本课程中，您将学习如何使用 GPS 传感器，首先学习如何定义地球上的位置。

## 地理空间坐标

地理空间坐标用于定义地球表面上的点，类似于如何使用坐标绘制计算机屏幕上的像素或在十字绣中定位针迹。对于单个点，您有一对坐标。例如，位于美国华盛顿州雷德蒙德的 Microsoft 园区的地址为 47.6423109、-122.1390293。

##＃ 纬度和经度

地球是一个球体——一个三维圆。因此，点是通过将其划分为 360 度来定义的，与圆的几何形状相同。纬度测量从北到南的度数，经度测量从东到西的度数。

> 💁 没有人真正知道圆分为 360 度的最初原因。维基百科上的[度（角度）页面](https://wikipedia.org/wiki/Degree_(angle)) 涵盖了一些可能的原因。

![从北极 90° 到北极和赤道中间 45°、赤道 0°、赤道到南极中间 -45° 以及南极 -90° 的纬度线](../../../../images/latitude-lines.png)

纬度是使用环绕地球并平行于赤道的线来测量的，将北半球和南半球各分为 90°。赤道为 0°，北极为 90°，也称为北纬 90°，南极为 -90°，或南纬 90°。

经度是通过向东和向西测量的度数来测量的。经度的 0° 原点称为 `本初子午线` ，于 1884 年定义为从北极到南极、穿过[位于英格兰格林威治的英国皇家天文台](https://wikipedia.org/wiki/Royal_Observatory,_Greenwich)。

![从 -180° 到本初子午线以西、到本初子午线 0°、到本初子午线以东 180° 的经线](../../../../images/longitude-meridians.png)

> 🎓 子午线是一条假想的直线，从北极到南极，形成一个半圆。

要测量某个点的经度，请测量从本初子午线到经过该点的子午线绕赤道的度数。经度从 -180°（即西经 180°）经过本初子午线的 0°，到达 180°（即东经 180°）。 180° 和 -180° 指的是同一点，即反子午线或第 180 条子午线。这是与本初子午线位于地球另一侧的子午线。

> 💁 不要将反子午线与国际日期变更线混淆，国际日期变更线的位置大致相同，但不是一条直线，而是根据地缘政治边界而变化。

✅ 做一些研究：尝试找到您当前位置的纬度和经度。

### 度、分、秒与十进制度

传统上，纬度和经度的测量是使用六十进位编号或以 60 为基数进行的，这是最早测量和记录时间和距离的古巴比伦人使用的一种编号系统。您每天都会使用六十进制，甚至可能没有意识到 - 将小时划分为 60 分钟，将分钟划分为 60 秒。

经度和纬度以度、分、秒为单位，一分钟为 1/60 度，1 秒为 1/60 分钟。

例如，在赤道：

* 1°纬度为**111.3公里**
* 1 分钟纬度为 111.3/60 = **1.855 公里**
* 1 秒纬度为 1.855/60 = **0.031 公里**

分钟的符号是单引号，秒的符号是双引号。例如，2 度 17 分 43 秒可写为 2°17'43"。秒的部分内容以小数形式给出，例如半秒为 0°0'0.5"。

计算机不能以 60 为基数工作，因此在大多数计算机系统中使用 GPS 数据时，这些坐标都以十进制形式给出。例如，2°17'43" 为 2.295277。度数符号通常被省略。

点的坐标始终以 `纬度、经度` 形式给出，因此前面的 Microsoft Campus 47.6423109,-122.117198 的示例具有：

* 纬度 47.6423109（赤道以北 47.6423109 度）
* 经度 -122.1390293（本初子午线以西 122.1390293 度）。

![微软园区 47.6423109,-122.117198](../../../../images/microsoft-gps-location-world.png)

## 全球定位系统 (GPS)

GPS 系统使用多个绕地球运行的卫星来定位您的位置。您可能在不知不觉中使用过 GPS 系统 - 在手机上的地图应用程序（例如 Apple 地图或 Google 地图）上查找您的位置，或者在打车应用程序（例如 Uber 或 Lyft）中查看您的乘车地点，或者在汽车中使用卫星导航 (sat-n​​av) 时。

> 🎓 `卫星导航` 中的卫星是GPS卫星！

GPS 系统的工作原理是通过多个卫星发送包含每颗卫星当前位置和准确时间戳的信号。这些信号通过无线电波发送，并由 GPS 传感器中的天线检测到。 GPS 传感器将检测这些信号，并使用当前时间测量信号从卫星到达传感器所需的时间。由于无线电波的速度是恒定的，GPS 传感器可以使用发送的时间戳来计算出传感器距卫星的距离。通过将至少 3 颗卫星的数据与发送的位置相结合，GPS 传感器能够精确定位其在地球上的位置。

> 💁 GPS 传感器需要天线来检测无线电波。配备车载 GPS 的卡车和汽车中内置的天线通常位于挡风玻璃或车顶上，以获取良好的信号。如果您使用单独的 GPS 系统，例如智能手机或物联网设备，那么您需要确保 GPS 系统或手机内置的天线能够清晰地看到天空，例如安装在挡风玻璃上。

![通过知道传感器到多颗卫星的距离，计算出位置](../../../../images/gps-satellites.png)

GPS 卫星绕地球运行，而不是在传感器上方的固定点，因此位置数据包括海拔高度以及纬度和经度。

过去，美国军方对 GPS 的精度有限制，将精度限制在 5 米左右。这一限制在 2000 年被取消，精度达到 30 厘米。由于信号干扰，并不总是能够达到这种精度。

✅ 如果您有智能手机，请启动地图应用程序并查看您的位置的准确度。您的手机可能需要很短的时间来检测多个卫星才能获得更准确的位置。

> 💁 卫星包含极其精确的原子钟，但与地球上的原子钟相比，它们每天会漂移 38 微秒（0.0000038 秒），这是因为正如爱因斯坦狭义相对论和广义相对论所预测的那样，时间会随着速度的增加而减慢 -卫星的运行速度比地球的自转速度快。这种漂移已被用来证明狭义相对论和广义相对论的预测，并且必须在 GPS 系统的设计中进行调整。从字面上看，在 GPS 卫星上时间过得更慢。

GPS 系统已由美国、俄罗斯、日本、印度、欧盟和中国等许多国家和政治联盟开发和部署。现代 GPS 传感器可以连接到大多数此类系统，以获得更快、更准确的修复。

> 🎓 每次部署中的卫星组称为星座。

## 读取GPS传感器数据

大多数 GPS 传感器通过 UART 发送 GPS 数据。

> ⚠️ UART 在[项目 2，第 2 课](../../../2-farm/lessons/2-detect-soil-moisture/README.md#universal-asynchronous-receiver-transmitter-uart)。如果需要，请回顾该课程。

您可以使用 IoT 设备上的 GPS 传感器来获取 GPS 数据。

### 任务 - 连接 GPS 传感器并读取 GPS 数据

完成相关指南以使用 IoT 设备读取 GPS 数据：

* [Arduino - Wio 终端](../wio-terminal-gps-sensor.md)
* [单板计算机-Raspberry Pi](../pi-gps-sensor.md)
* [单板机-虚拟设备](../virtual-device-gps-sensor.md)

## NMEA GPS 数据

当您运行代码时，您会看到输出中可能出现乱码。这实际上是标准的 GPS 数据，并且都有意义。

GPS 传感器使用 NMEA 消息和 NMEA 0183 标准输出数据。 NMEA 是[国家海洋电子协会](https://www.nmea.org) 的缩写，这是一个总部位于美国的贸易组织，为海洋电子设备之间的通信制定标准。

> 💁 该标准是专有的，售价至少为 2,000 美元，但有关该标准的足够信息已在公共领域，该标准的大部分内容都经过了逆向工程，可用于开源和其他非商业代码。

这些消息是基于文本的。每条消息由一个以 `$` 字符开头的*句子*组成，后跟 2 个字符以指示消息的来源（例如 GP 表示美国 GPS 系统，GN 表示 GLONASS、俄罗斯 GPS 系统），最后是 3 个字符来指示消息的类型。消息的其余部分是用逗号分隔的字段，以换行符结尾。

可以接收的一些消息类型是：

|类型 |描述 |
| ---- | ----------- |
| GGA | GPS Fix Data, including the latitude, longitude, and altitude of the GPS sensor, along with the number of satellites in view to calculate this fix. |
| ZDA | The current date and time, including the local time zone |
| GSV | Details of the satellites in view - defined as the satellited that GPS sensor can detect signals from |

> 💁 GPS data includes time stamps, so your IoT device can get the time if needed from a GPS sensor, rather than relying on an NTP server or internal real-time clock. |

> 💁 GPS 数据包含时间戳，因此您的 IoT 设备可以根据需要从 GPS 传感器获取时间，而不是依赖 NTP 服务器或内部实时时钟。

GGA 消息包含使用 `(dd)dmm.mmmm` 格式的当前位置，以及指示方向的单个字符。格式中的  `d` 是度， `m` 是分钟，秒是分钟的小数。例如，2°17'43" 将为 217.716666667 - 2 度、17.716666667 分钟。

方向字符可以是  `N` 或 `S` ，表示纬度，表示北或南；方向字符可以是 `E` 或 `W` ，表示经度，表示东或西。例如，纬度 2°17'43" 将具有方向字符 `N` ，-2°17'43" 将具有方向字符 `S` 。

例如 - NMEA 句子 `$GNGGA,020604.001,4738.538654,N,12208.341758,W,1,3,,164.7,M,-17.1,M,,*67`

* 纬度部分为 `4738.538654,N`，转换为十进制度数 47.6423109。 `4738.538654` 是 47.6423109，方向是 `N`（北），所以是正纬度。

* 经度部分为`12208.341758,W`，转换为十进制度数的-122.1390293。 `12208.341758` 是122.1390293°，方向是`W`（西），所以是负经度。

## 解码 GPS 传感器数据

与其使用原始 NMEA 数据，不如将其解码为更有用的格式。您可以使用多个开源库来帮助从原始 NMEA 消息中提取有用的数据。

### 任务 - 解码 GPS 传感器数据

完成相关指南，使用 IoT 设备解码 GPS 传感器数据：

* [Arduino - Wio 终端](../wio-terminal-gps-decode.md)
* [单板计算机-Raspberry Pi/虚拟物联网设备](../single-board-computer-gps-decode.md)

---

## 🚀 挑战

编写您自己的 NMEA 解码器！您可以编写自己的解码器来从 NMEA 句子中提取纬度和经度，而不是依赖第三方库来解码 NMEA 句子吗？

## 课后测验

[课后测验](https://black-meadow-040d15503.1.azurestaticapps.net/quiz/22)

## 复习与自学

* 有关地理空间坐标的更多信息，请访问 [维基百科上的地理坐标系页面](https://wikipedia.org/wiki/Geographic_coefficient_system)。
* 在[维基百科上的本初子午线页面](https://wikipedia.org/wiki/Prime_meridian#Prime_meridian_on_other_planetary_bodies) 上了解除地球之外的其他天体上的本初子午线
* 研究欧盟、日本、俄罗斯、印度和美国等世界各国政府和政治联盟的各种不同的 GPS 系统。

## 作业

[调查其他 GPS 数据](../assignment.md)